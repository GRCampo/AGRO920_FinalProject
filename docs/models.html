<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 Models | Models</title>
  <meta name="description" content="This report covers all classes from PLPTH 820 course." />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="7 Models | Models" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This report covers all classes from PLPTH 820 course." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 Models | Models" />
  
  <meta name="twitter:description" content="This report covers all classes from PLPTH 820 course." />
  

<meta name="author" content="Gabriela Romero Campos" />


<meta name="date" content="2025-05-14" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="exploratory-analysis.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="libs/plotly-binding-4.10.0/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">AGRO 920</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#data"><i class="fa fa-check"></i><b>1.1</b> Data</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#project-overview"><i class="fa fa-check"></i><b>1.2</b> Project Overview</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.2.1</b> Objective</a></li>
<li class="chapter" data-level="1.2.2" data-path="index.html"><a href="index.html#why-k-mers"><i class="fa fa-check"></i><b>1.2.2</b> Why k-mers?</a></li>
<li class="chapter" data-level="1.2.3" data-path="index.html"><a href="index.html#why-pseudo-samples-ps"><i class="fa fa-check"></i><b>1.2.3</b> Why pseudo-samples (PS)?</a></li>
<li class="chapter" data-level="1.2.4" data-path="index.html"><a href="index.html#why-machine-learning"><i class="fa fa-check"></i><b>1.2.4</b> Why machine learning?</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-acquisition.html"><a href="data-acquisition.html"><i class="fa fa-check"></i><b>2</b> Data Acquisition</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-acquisition.html"><a href="data-acquisition.html#download"><i class="fa fa-check"></i><b>2.1</b> Download</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="quality-control.html"><a href="quality-control.html"><i class="fa fa-check"></i><b>3</b> Quality Control</a>
<ul>
<li class="chapter" data-level="3.1" data-path="quality-control.html"><a href="quality-control.html#fastqc-and-multiqc"><i class="fa fa-check"></i><b>3.1</b> FastQC and MultiQC</a></li>
<li class="chapter" data-level="3.2" data-path="quality-control.html"><a href="quality-control.html#duplicate-removal-with-markduplicates"><i class="fa fa-check"></i><b>3.2</b> Duplicate Removal with MarkDuplicates</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="pseudosamples-from-raw-reads.html"><a href="pseudosamples-from-raw-reads.html"><i class="fa fa-check"></i><b>4</b> Pseudosamples from Raw Reads</a>
<ul>
<li class="chapter" data-level="4.1" data-path="pseudosamples-from-raw-reads.html"><a href="pseudosamples-from-raw-reads.html#merge-paired-end-reads-into-a-single-fasta"><i class="fa fa-check"></i><b>4.1</b> Merge Paired-end Reads into a Single FASTA</a></li>
<li class="chapter" data-level="4.2" data-path="pseudosamples-from-raw-reads.html"><a href="pseudosamples-from-raw-reads.html#split-into-pseudosamples"><i class="fa fa-check"></i><b>4.2</b> Split into Pseudosamples</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html"><i class="fa fa-check"></i><b>5</b> K-mer Extraction and Filtering</a>
<ul>
<li class="chapter" data-level="5.1" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#k-mer-counting-with-jellyfish"><i class="fa fa-check"></i><b>5.1</b> K-mer Counting with Jellyfish</a></li>
<li class="chapter" data-level="5.2" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#pseudosample-merging-by-treatment"><i class="fa fa-check"></i><b>5.2</b> Pseudosample Merging by Treatment</a></li>
<li class="chapter" data-level="5.3" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#global-merging-by-group"><i class="fa fa-check"></i><b>5.3</b> Global Merging by Group</a></li>
<li class="chapter" data-level="5.4" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#aggregation-and-total-count-per-k-mer"><i class="fa fa-check"></i><b>5.4</b> Aggregation and Total Count per K-mer</a></li>
<li class="chapter" data-level="5.5" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#filtering-kmers"><i class="fa fa-check"></i><b>5.5</b> Filtering kmers</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#step-1-abundance-threshold"><i class="fa fa-check"></i><b>5.5.1</b> Step 1: Abundance Threshold</a></li>
<li class="chapter" data-level="5.5.2" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#step-2-coefficient-of-variation-cv"><i class="fa fa-check"></i><b>5.5.2</b> Step 2: Coefficient of Variation (CV)</a></li>
<li class="chapter" data-level="5.5.3" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#step-3-redundancy-removal-with-cd-hit-est"><i class="fa fa-check"></i><b>5.5.3</b> Step 3: Redundancy Removal with CD-HIT-EST</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html"><i class="fa fa-check"></i><b>6</b> Exploratory Analysis</a>
<ul>
<li class="chapter" data-level="6.1" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#total-counts"><i class="fa fa-check"></i><b>6.1</b> Total counts</a></li>
<li class="chapter" data-level="6.2" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#variance"><i class="fa fa-check"></i><b>6.2</b> Variance</a></li>
<li class="chapter" data-level="6.3" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#pca"><i class="fa fa-check"></i><b>6.3</b> PCA</a></li>
<li class="chapter" data-level="6.4" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#t-sne"><i class="fa fa-check"></i><b>6.4</b> t-SNE</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="models.html"><a href="models.html"><i class="fa fa-check"></i><b>7</b> Models</a>
<ul>
<li class="chapter" data-level="7.1" data-path="models.html"><a href="models.html#random-forest"><i class="fa fa-check"></i><b>7.1</b> Random Forest</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="models.html"><a href="models.html#confusion-matrices"><i class="fa fa-check"></i><b>7.1.1</b> Confusion Matrices</a></li>
<li class="chapter" data-level="7.1.2" data-path="models.html"><a href="models.html#performance-metrics-and-roc-curves"><i class="fa fa-check"></i><b>7.1.2</b> Performance Metrics and ROC Curves</a></li>
<li class="chapter" data-level="7.1.3" data-path="models.html"><a href="models.html#important-k-mers-associated-with-heat-stress-1h"><i class="fa fa-check"></i><b>7.1.3</b> Important k-mers associated with heat stress (1h)</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Models</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="models" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">7</span> Models<a href="models.html#models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="random-forest" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Random Forest<a href="models.html#random-forest" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To explore how well the data could be classified, I tested a grid of hyperparameter combinations, varying two core knobs of the Random Forest algorithm:</p>
<ul>
<li><p><code>mtry</code>: Number of variables randomly sampled at each split (set to 500, 1000, and p — where p is the total number of predictors)</p></li>
<li><p><code>nodesize</code>: Minimum number of samples per terminal node (set to 5, 10, and 20)</p></li>
</ul>
<p>These values were chosen to explore the tradeoff between shallow vs deep trees and narrow vs wide feature subsets.</p>
<p>The models were trained and evaluated using a one-vs-all strategy for four stress conditions. For each condition, one biological replicate was used for training and the other for testing because, as you may recall, I only had two replicates per condition and had to get creative.</p>
<p>Thanks to the 13k+ predictors, 4 stress conditions, and 9 hyperparameter combos, training all models took around <strong>20 hours on 30 parallel workers</strong>. Each Random Forest used <strong>500 trees</strong> and applied class weights to reduce the classic “I’ll-just-predict-the-majority-class” laziness.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="models.html#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb36-2"><a href="models.html#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="models.html#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;STARTING SCRIPT AT: &quot;</span>, <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb36-4"><a href="models.html#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="models.html#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Data ----</span></span>
<span id="cb36-6"><a href="models.html#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb36-7"><a href="models.html#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb36-8"><a href="models.html#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span>
<span id="cb36-9"><a href="models.html#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb36-10"><a href="models.html#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb36-11"><a href="models.html#cb36-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-12"><a href="models.html#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Loading data...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb36-13"><a href="models.html#cb36-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-14"><a href="models.html#cb36-14" aria-hidden="true" tabindex="-1"></a>count_clean2 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&#39;~/AGRO920/results/count_clean2.rds&#39;</span>)</span>
<span id="cb36-15"><a href="models.html#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="models.html#cb36-16" aria-hidden="true" tabindex="-1"></a>treat_map <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">SRR1542404 =</span> <span class="st">&quot;Control&quot;</span>, <span class="at">SRR1542405 =</span> <span class="st">&quot;Control&quot;</span>,</span>
<span id="cb36-17"><a href="models.html#cb36-17" aria-hidden="true" tabindex="-1"></a>               <span class="at">SRR1542406 =</span> <span class="st">&quot;Drought_1h&quot;</span>, <span class="at">SRR1542407 =</span> <span class="st">&quot;Drought_1h&quot;</span>,</span>
<span id="cb36-18"><a href="models.html#cb36-18" aria-hidden="true" tabindex="-1"></a>               <span class="at">SRR1542408 =</span> <span class="st">&quot;Drought_6h&quot;</span>, <span class="at">SRR1542409 =</span> <span class="st">&quot;Drought_6h&quot;</span>,</span>
<span id="cb36-19"><a href="models.html#cb36-19" aria-hidden="true" tabindex="-1"></a>               <span class="at">SRR1542410 =</span> <span class="st">&quot;Heat_1h&quot;</span>, <span class="at">SRR1542411 =</span> <span class="st">&quot;Heat_1h&quot;</span>,</span>
<span id="cb36-20"><a href="models.html#cb36-20" aria-hidden="true" tabindex="-1"></a>               <span class="at">SRR1542412 =</span> <span class="st">&quot;Heat_6h&quot;</span>, <span class="at">SRR1542413 =</span> <span class="st">&quot;Heat_6h&quot;</span>,</span>
<span id="cb36-21"><a href="models.html#cb36-21" aria-hidden="true" tabindex="-1"></a>               <span class="at">SRR1542414 =</span> <span class="st">&quot;Drought_Heat_1h&quot;</span>,<span class="at">SRR1542415 =</span> <span class="st">&quot;Drought_Heat_1h&quot;</span>,</span>
<span id="cb36-22"><a href="models.html#cb36-22" aria-hidden="true" tabindex="-1"></a>               <span class="at">SRR1542416 =</span> <span class="st">&quot;Drought_Heat_6h&quot;</span>, <span class="at">SRR1542417 =</span> <span class="st">&quot;Drought_Heat_6h&quot;</span>)</span>
<span id="cb36-23"><a href="models.html#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="models.html#cb36-24" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">sample =</span> <span class="fu">sub</span>(<span class="st">&quot;_.*&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="fu">rownames</span>(count_clean2)),</span>
<span id="cb36-25"><a href="models.html#cb36-25" aria-hidden="true" tabindex="-1"></a>                <span class="at">ps =</span> <span class="fu">rownames</span>(count_clean2))</span>
<span id="cb36-26"><a href="models.html#cb36-26" aria-hidden="true" tabindex="-1"></a>y<span class="sc">$</span>treat <span class="ot">&lt;-</span> <span class="fu">factor</span>(treat_map[y<span class="sc">$</span>sample])</span>
<span id="cb36-27"><a href="models.html#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="models.html#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2310</span>)</span>
<span id="cb36-29"><a href="models.html#cb36-29" aria-hidden="true" tabindex="-1"></a>sort_data <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Sample =</span> <span class="fu">sort</span>(<span class="fu">unique</span>(y<span class="sc">$</span>sample)),</span>
<span id="cb36-30"><a href="models.html#cb36-30" aria-hidden="true" tabindex="-1"></a>                        <span class="at">Rep =</span> <span class="fu">factor</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>))</span>
<span id="cb36-31"><a href="models.html#cb36-31" aria-hidden="true" tabindex="-1"></a>sort_data<span class="sc">$</span>Trat <span class="ot">&lt;-</span> treat_map[sort_data<span class="sc">$</span>Sample] </span>
<span id="cb36-32"><a href="models.html#cb36-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-33"><a href="models.html#cb36-33" aria-hidden="true" tabindex="-1"></a>group1 <span class="ot">&lt;-</span> sort_data <span class="sc">%&gt;%</span> </span>
<span id="cb36-34"><a href="models.html#cb36-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Trat) <span class="sc">%&gt;%</span> </span>
<span id="cb36-35"><a href="models.html#cb36-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_sample</span>(<span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb36-36"><a href="models.html#cb36-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb36-37"><a href="models.html#cb36-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-38"><a href="models.html#cb36-38" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> <span class="fu">filter</span>(y, sample <span class="sc">%in%</span> group1<span class="sc">$</span>Sample) </span>
<span id="cb36-39"><a href="models.html#cb36-39" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span> <span class="fu">filter</span>(y, <span class="sc">!</span>(sample <span class="sc">%in%</span> group1<span class="sc">$</span>Sample)) </span>
<span id="cb36-40"><a href="models.html#cb36-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-41"><a href="models.html#cb36-41" aria-hidden="true" tabindex="-1"></a>train_idx <span class="ot">&lt;-</span> <span class="fu">rownames</span>(count_clean2) <span class="sc">%in%</span> y_train<span class="sc">$</span>ps</span>
<span id="cb36-42"><a href="models.html#cb36-42" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">&lt;-</span> count_clean2[train_idx, , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb36-43"><a href="models.html#cb36-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-44"><a href="models.html#cb36-44" aria-hidden="true" tabindex="-1"></a>test_idx <span class="ot">&lt;-</span> <span class="fu">rownames</span>(count_clean2) <span class="sc">%in%</span> y_test<span class="sc">$</span>ps</span>
<span id="cb36-45"><a href="models.html#cb36-45" aria-hidden="true" tabindex="-1"></a>X_test <span class="ot">&lt;-</span> count_clean2[test_idx,  , drop <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb36-46"><a href="models.html#cb36-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-47"><a href="models.html#cb36-47" aria-hidden="true" tabindex="-1"></a>treatments <span class="ot">&lt;-</span> <span class="fu">unique</span>(y_train<span class="sc">$</span>treat)</span>
<span id="cb36-48"><a href="models.html#cb36-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-49"><a href="models.html#cb36-49" aria-hidden="true" tabindex="-1"></a>labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;drought_1h&quot;</span>, <span class="st">&quot;drought_6h&quot;</span>, <span class="st">&quot;heat_1h&quot;</span>, <span class="st">&quot;heat_6h&quot;</span>)</span>
<span id="cb36-50"><a href="models.html#cb36-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-51"><a href="models.html#cb36-51" aria-hidden="true" tabindex="-1"></a>y_multi <span class="ot">&lt;-</span> y[, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="sc">%&gt;%</span></span>
<span id="cb36-52"><a href="models.html#cb36-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">drought_1h =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(treat, <span class="st">&quot;Drought&quot;</span>) <span class="sc">&amp;</span> <span class="fu">str_detect</span>(treat, <span class="st">&quot;1h&quot;</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb36-53"><a href="models.html#cb36-53" aria-hidden="true" tabindex="-1"></a>         <span class="at">drought_6h =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(treat, <span class="st">&quot;Drought&quot;</span>) <span class="sc">&amp;</span> <span class="fu">str_detect</span>(treat, <span class="st">&quot;6h&quot;</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb36-54"><a href="models.html#cb36-54" aria-hidden="true" tabindex="-1"></a>         <span class="at">heat_1h =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(treat, <span class="st">&quot;Heat&quot;</span>) <span class="sc">&amp;</span> <span class="fu">str_detect</span>(treat, <span class="st">&quot;1h&quot;</span>), <span class="dv">1</span>, <span class="dv">0</span>),</span>
<span id="cb36-55"><a href="models.html#cb36-55" aria-hidden="true" tabindex="-1"></a>         <span class="at">heat_6h =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(treat, <span class="st">&quot;Heat&quot;</span>) <span class="sc">&amp;</span> <span class="fu">str_detect</span>(treat, <span class="st">&quot;6h&quot;</span>), <span class="dv">1</span>, <span class="dv">0</span>))</span>
<span id="cb36-56"><a href="models.html#cb36-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-57"><a href="models.html#cb36-57" aria-hidden="true" tabindex="-1"></a>y_train_multi <span class="ot">&lt;-</span> y_multi <span class="sc">%&gt;%</span> </span>
<span id="cb36-58"><a href="models.html#cb36-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(sample <span class="sc">%in%</span> group1<span class="sc">$</span>Sample) <span class="sc">%&gt;%</span> </span>
<span id="cb36-59"><a href="models.html#cb36-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>sample, <span class="sc">-</span>treat)</span>
<span id="cb36-60"><a href="models.html#cb36-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-61"><a href="models.html#cb36-61" aria-hidden="true" tabindex="-1"></a>y_test_multi <span class="ot">&lt;-</span> y_multi <span class="sc">%&gt;%</span> </span>
<span id="cb36-62"><a href="models.html#cb36-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>(sample <span class="sc">%in%</span> group1<span class="sc">$</span>Sample)) <span class="sc">%&gt;%</span> </span>
<span id="cb36-63"><a href="models.html#cb36-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>sample, <span class="sc">-</span>treat)</span>
<span id="cb36-64"><a href="models.html#cb36-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-65"><a href="models.html#cb36-65" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(X_train)</span>
<span id="cb36-66"><a href="models.html#cb36-66" aria-hidden="true" tabindex="-1"></a>X_train<span class="sc">$</span>control <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(y_train<span class="sc">$</span>treat <span class="sc">==</span> <span class="st">&quot;Control&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb36-67"><a href="models.html#cb36-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-68"><a href="models.html#cb36-68" aria-hidden="true" tabindex="-1"></a>X_test <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(X_test)</span>
<span id="cb36-69"><a href="models.html#cb36-69" aria-hidden="true" tabindex="-1"></a>X_test<span class="sc">$</span>control <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(y_test<span class="sc">$</span>treat <span class="sc">==</span> <span class="st">&quot;Control&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb36-70"><a href="models.html#cb36-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-71"><a href="models.html#cb36-71" aria-hidden="true" tabindex="-1"></a><span class="do">## Training ----</span></span>
<span id="cb36-72"><a href="models.html#cb36-72" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;TRAINING MODELS - START: &quot;</span>, <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb36-73"><a href="models.html#cb36-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-74"><a href="models.html#cb36-74" aria-hidden="true" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="dv">30</span>)</span>
<span id="cb36-75"><a href="models.html#cb36-75" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb36-76"><a href="models.html#cb36-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-77"><a href="models.html#cb36-77" aria-hidden="true" tabindex="-1"></a>mtry_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">500</span>, <span class="dv">1000</span>, <span class="fu">ncol</span>(X_train))</span>
<span id="cb36-78"><a href="models.html#cb36-78" aria-hidden="true" tabindex="-1"></a>nodesize_vals <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">20</span>)</span>
<span id="cb36-79"><a href="models.html#cb36-79" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">mtry =</span> mtry_vals, <span class="at">nodesize =</span> nodesize_vals)</span>
<span id="cb36-80"><a href="models.html#cb36-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-81"><a href="models.html#cb36-81" aria-hidden="true" tabindex="-1"></a>results_grid <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb36-82"><a href="models.html#cb36-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-83"><a href="models.html#cb36-83" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (label <span class="cf">in</span> labels) {</span>
<span id="cb36-84"><a href="models.html#cb36-84" aria-hidden="true" tabindex="-1"></a>  results_grid[[label]] <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid), <span class="at">.packages =</span> <span class="st">&quot;randomForest&quot;</span>) <span class="sc">%dopar%</span> {</span>
<span id="cb36-85"><a href="models.html#cb36-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-86"><a href="models.html#cb36-86" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> grid<span class="sc">$</span>mtry[i]</span>
<span id="cb36-87"><a href="models.html#cb36-87" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> grid<span class="sc">$</span>nodesize[i]</span>
<span id="cb36-88"><a href="models.html#cb36-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-89"><a href="models.html#cb36-89" aria-hidden="true" tabindex="-1"></a>    result_model_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb36-90"><a href="models.html#cb36-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-91"><a href="models.html#cb36-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (t <span class="cf">in</span> treatments) {</span>
<span id="cb36-92"><a href="models.html#cb36-92" aria-hidden="true" tabindex="-1"></a>      idx_test <span class="ot">&lt;-</span> <span class="fu">which</span>(y_train<span class="sc">$</span>treat <span class="sc">==</span> t)</span>
<span id="cb36-93"><a href="models.html#cb36-93" aria-hidden="true" tabindex="-1"></a>      idx_train <span class="ot">&lt;-</span> <span class="fu">which</span>(y_train<span class="sc">$</span>treat <span class="sc">!=</span> t)</span>
<span id="cb36-94"><a href="models.html#cb36-94" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb36-95"><a href="models.html#cb36-95" aria-hidden="true" tabindex="-1"></a>      X_tmp <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(X_train[idx_train, ])</span>
<span id="cb36-96"><a href="models.html#cb36-96" aria-hidden="true" tabindex="-1"></a>      X_tmp<span class="sc">$</span>control <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(y_train<span class="sc">$</span>treat[idx_train] <span class="sc">==</span> <span class="st">&quot;Control&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb36-97"><a href="models.html#cb36-97" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb36-98"><a href="models.html#cb36-98" aria-hidden="true" tabindex="-1"></a>      y_tmp <span class="ot">&lt;-</span> <span class="fu">factor</span>(y_train_multi[[label]][idx_train])</span>
<span id="cb36-99"><a href="models.html#cb36-99" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb36-100"><a href="models.html#cb36-100" aria-hidden="true" tabindex="-1"></a>      rf_model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(<span class="at">x =</span> X_tmp,</span>
<span id="cb36-101"><a href="models.html#cb36-101" aria-hidden="true" tabindex="-1"></a>                               <span class="at">y =</span> y_tmp,</span>
<span id="cb36-102"><a href="models.html#cb36-102" aria-hidden="true" tabindex="-1"></a>                               <span class="at">ntree =</span> <span class="dv">500</span>,</span>
<span id="cb36-103"><a href="models.html#cb36-103" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mtry =</span> m,</span>
<span id="cb36-104"><a href="models.html#cb36-104" aria-hidden="true" tabindex="-1"></a>                               <span class="at">nodesize =</span> n,</span>
<span id="cb36-105"><a href="models.html#cb36-105" aria-hidden="true" tabindex="-1"></a>                               <span class="at">importance =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-106"><a href="models.html#cb36-106" aria-hidden="true" tabindex="-1"></a>                               <span class="at">classwt =</span> <span class="fu">c</span>(<span class="st">&quot;0&quot;</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="fl">2.5</span>))</span>
<span id="cb36-107"><a href="models.html#cb36-107" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb36-108"><a href="models.html#cb36-108" aria-hidden="true" tabindex="-1"></a>      pred_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_model, <span class="at">newdata =</span> <span class="fu">cbind</span>(X_train[idx_test, ], <span class="at">control =</span> <span class="fu">ifelse</span>(y_train<span class="sc">$</span>treat[idx_test] <span class="sc">==</span> <span class="st">&quot;Control&quot;</span>, <span class="dv">1</span>, <span class="dv">0</span>)),<span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)[, <span class="dv">2</span>]</span>
<span id="cb36-109"><a href="models.html#cb36-109" aria-hidden="true" tabindex="-1"></a>      pred <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pred_prob <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb36-110"><a href="models.html#cb36-110" aria-hidden="true" tabindex="-1"></a>      obs <span class="ot">&lt;-</span> y_train_multi[[label]][idx_test]</span>
<span id="cb36-111"><a href="models.html#cb36-111" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb36-112"><a href="models.html#cb36-112" aria-hidden="true" tabindex="-1"></a>      result_model_list[[t]] <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">treatment =</span> t,</span>
<span id="cb36-113"><a href="models.html#cb36-113" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">predicted =</span> pred,</span>
<span id="cb36-114"><a href="models.html#cb36-114" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">prob =</span> pred_prob,</span>
<span id="cb36-115"><a href="models.html#cb36-115" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">observed =</span> obs,</span>
<span id="cb36-116"><a href="models.html#cb36-116" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">mtry =</span> m,</span>
<span id="cb36-117"><a href="models.html#cb36-117" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">nodesize =</span> n)</span>
<span id="cb36-118"><a href="models.html#cb36-118" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-119"><a href="models.html#cb36-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-120"><a href="models.html#cb36-120" aria-hidden="true" tabindex="-1"></a>    <span class="fu">do.call</span>(rbind, result_model_list)</span>
<span id="cb36-121"><a href="models.html#cb36-121" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-122"><a href="models.html#cb36-122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-123"><a href="models.html#cb36-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-124"><a href="models.html#cb36-124" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;TRAINING MODELS - END: &quot;</span>, <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb36-125"><a href="models.html#cb36-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-126"><a href="models.html#cb36-126" aria-hidden="true" tabindex="-1"></a><span class="do">## Test ----</span></span>
<span id="cb36-127"><a href="models.html#cb36-127" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;TESTING MODELS - START: &quot;</span>, <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb36-128"><a href="models.html#cb36-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-129"><a href="models.html#cb36-129" aria-hidden="true" tabindex="-1"></a>rf_test_models <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb36-130"><a href="models.html#cb36-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-131"><a href="models.html#cb36-131" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (label <span class="cf">in</span> labels) {</span>
<span id="cb36-132"><a href="models.html#cb36-132" aria-hidden="true" tabindex="-1"></a>  y_train_label <span class="ot">&lt;-</span> <span class="fu">factor</span>(y_train_multi[[label]])</span>
<span id="cb36-133"><a href="models.html#cb36-133" aria-hidden="true" tabindex="-1"></a>  y_test_label  <span class="ot">&lt;-</span> <span class="fu">factor</span>(y_test_multi[[label]])</span>
<span id="cb36-134"><a href="models.html#cb36-134" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-135"><a href="models.html#cb36-135" aria-hidden="true" tabindex="-1"></a>  rf_test_models[[label]] <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(grid), <span class="at">.packages =</span> <span class="st">&quot;randomForest&quot;</span>) <span class="sc">%dopar%</span> {</span>
<span id="cb36-136"><a href="models.html#cb36-136" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> grid<span class="sc">$</span>mtry[i]</span>
<span id="cb36-137"><a href="models.html#cb36-137" aria-hidden="true" tabindex="-1"></a>    n <span class="ot">&lt;-</span> grid<span class="sc">$</span>nodesize[i]</span>
<span id="cb36-138"><a href="models.html#cb36-138" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-139"><a href="models.html#cb36-139" aria-hidden="true" tabindex="-1"></a>    rf_model <span class="ot">&lt;-</span> <span class="fu">randomForest</span>(<span class="at">x =</span> X_train, <span class="at">y =</span> y_train_label,</span>
<span id="cb36-140"><a href="models.html#cb36-140" aria-hidden="true" tabindex="-1"></a>                             <span class="at">ntree =</span> <span class="dv">500</span>,</span>
<span id="cb36-141"><a href="models.html#cb36-141" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mtry =</span> m,</span>
<span id="cb36-142"><a href="models.html#cb36-142" aria-hidden="true" tabindex="-1"></a>                             <span class="at">nodesize =</span> n,</span>
<span id="cb36-143"><a href="models.html#cb36-143" aria-hidden="true" tabindex="-1"></a>                             <span class="at">importance =</span> <span class="cn">TRUE</span>,</span>
<span id="cb36-144"><a href="models.html#cb36-144" aria-hidden="true" tabindex="-1"></a>                             <span class="at">classwt =</span> <span class="fu">c</span>(<span class="st">&quot;0&quot;</span> <span class="ot">=</span> <span class="dv">1</span>, <span class="st">&quot;1&quot;</span> <span class="ot">=</span> <span class="fl">2.5</span>))</span>
<span id="cb36-145"><a href="models.html#cb36-145" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-146"><a href="models.html#cb36-146" aria-hidden="true" tabindex="-1"></a>    pred_prob <span class="ot">&lt;-</span> <span class="fu">predict</span>(rf_model, X_test, <span class="at">type =</span> <span class="st">&quot;prob&quot;</span>)[,<span class="dv">2</span>]</span>
<span id="cb36-147"><a href="models.html#cb36-147" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(pred_prob <span class="sc">&gt;</span> <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb36-148"><a href="models.html#cb36-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-149"><a href="models.html#cb36-149" aria-hidden="true" tabindex="-1"></a>    acc <span class="ot">&lt;-</span> <span class="fu">mean</span>(pred <span class="sc">==</span> y_test_label)</span>
<span id="cb36-150"><a href="models.html#cb36-150" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-151"><a href="models.html#cb36-151" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">model =</span> rf_model,</span>
<span id="cb36-152"><a href="models.html#cb36-152" aria-hidden="true" tabindex="-1"></a>         <span class="at">mtry =</span> m,</span>
<span id="cb36-153"><a href="models.html#cb36-153" aria-hidden="true" tabindex="-1"></a>         <span class="at">nodesize =</span> n,</span>
<span id="cb36-154"><a href="models.html#cb36-154" aria-hidden="true" tabindex="-1"></a>         <span class="at">acc =</span> acc,</span>
<span id="cb36-155"><a href="models.html#cb36-155" aria-hidden="true" tabindex="-1"></a>         <span class="at">predictions =</span> pred,</span>
<span id="cb36-156"><a href="models.html#cb36-156" aria-hidden="true" tabindex="-1"></a>         <span class="at">predicted_prob =</span> pred_prob,</span>
<span id="cb36-157"><a href="models.html#cb36-157" aria-hidden="true" tabindex="-1"></a>         <span class="at">observed =</span> y_test_label)</span>
<span id="cb36-158"><a href="models.html#cb36-158" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-159"><a href="models.html#cb36-159" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-160"><a href="models.html#cb36-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-161"><a href="models.html#cb36-161" aria-hidden="true" tabindex="-1"></a><span class="fu">stopCluster</span>(cl)</span>
<span id="cb36-162"><a href="models.html#cb36-162" aria-hidden="true" tabindex="-1"></a><span class="fu">registerDoSEQ</span>()</span>
<span id="cb36-163"><a href="models.html#cb36-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-164"><a href="models.html#cb36-164" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;TESTING MODELS - END: &quot;</span>, <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb36-165"><a href="models.html#cb36-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-166"><a href="models.html#cb36-166" aria-hidden="true" tabindex="-1"></a><span class="do">## Saving ----</span></span>
<span id="cb36-167"><a href="models.html#cb36-167" aria-hidden="true" tabindex="-1"></a>RF_final <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">training =</span> results_grid,</span>
<span id="cb36-168"><a href="models.html#cb36-168" aria-hidden="true" tabindex="-1"></a>                 <span class="at">test =</span> rf_test_models)</span>
<span id="cb36-169"><a href="models.html#cb36-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-170"><a href="models.html#cb36-170" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(RF_final, <span class="st">&#39;~/AGRO920/results/RF_final.rds&#39;</span>)</span>
<span id="cb36-171"><a href="models.html#cb36-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-172"><a href="models.html#cb36-172" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;SCRIPT FINISHED AT: &quot;</span>, <span class="fu">as.character</span>(<span class="fu">Sys.time</span>()), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="models.html#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(caret)</span>
<span id="cb37-2"><a href="models.html#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb37-3"><a href="models.html#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="models.html#cb37-4" aria-hidden="true" tabindex="-1"></a>RF_final <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;~/AGRO920/results/RF_final.rds&quot;</span>)</span></code></pre></div>
<div id="confusion-matrices" class="section level3 hasAnchor" number="7.1.1">
<h3><span class="header-section-number">7.1.1</span> Confusion Matrices<a href="models.html#confusion-matrices" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="models.html#cb38-1" aria-hidden="true" tabindex="-1"></a>conf_mats <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb38-2"><a href="models.html#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="models.html#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (label <span class="cf">in</span> <span class="fu">names</span>(RF_final<span class="sc">$</span>test)) {</span>
<span id="cb38-4"><a href="models.html#cb38-4" aria-hidden="true" tabindex="-1"></a>  conf_mats[[label]] <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb38-5"><a href="models.html#cb38-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-6"><a href="models.html#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (model <span class="cf">in</span> RF_final<span class="sc">$</span>test[[label]]) {</span>
<span id="cb38-7"><a href="models.html#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="models.html#cb38-8" aria-hidden="true" tabindex="-1"></a>    obs <span class="ot">&lt;-</span> model<span class="sc">$</span>observed</span>
<span id="cb38-9"><a href="models.html#cb38-9" aria-hidden="true" tabindex="-1"></a>    pred <span class="ot">&lt;-</span> model<span class="sc">$</span>predictions</span>
<span id="cb38-10"><a href="models.html#cb38-10" aria-hidden="true" tabindex="-1"></a>    key <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;mtry=&quot;</span>, model<span class="sc">$</span>mtry, <span class="st">&quot;_node=&quot;</span>, model<span class="sc">$</span>nodesize)</span>
<span id="cb38-11"><a href="models.html#cb38-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-12"><a href="models.html#cb38-12" aria-hidden="true" tabindex="-1"></a>    cm <span class="ot">&lt;-</span> <span class="fu">table</span>(<span class="fu">factor</span>(obs, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)), <span class="fu">factor</span>(pred, <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)))</span>
<span id="cb38-13"><a href="models.html#cb38-13" aria-hidden="true" tabindex="-1"></a>    cm_prop <span class="ot">&lt;-</span> <span class="fu">prop.table</span>(cm, <span class="at">margin =</span> <span class="dv">1</span>)  </span>
<span id="cb38-14"><a href="models.html#cb38-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-15"><a href="models.html#cb38-15" aria-hidden="true" tabindex="-1"></a>    conf_mats[[label]][[key]] <span class="ot">&lt;-</span> cm_prop</span>
<span id="cb38-16"><a href="models.html#cb38-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-17"><a href="models.html#cb38-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-18"><a href="models.html#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="models.html#cb38-19" aria-hidden="true" tabindex="-1"></a>conf_df <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">names</span>(conf_mats), <span class="cf">function</span>(label) {</span>
<span id="cb38-20"><a href="models.html#cb38-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(<span class="fu">names</span>(conf_mats[[label]]), <span class="cf">function</span>(model_id) {</span>
<span id="cb38-21"><a href="models.html#cb38-21" aria-hidden="true" tabindex="-1"></a>    mat <span class="ot">&lt;-</span> conf_mats[[label]][[model_id]]</span>
<span id="cb38-22"><a href="models.html#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="models.html#cb38-23" aria-hidden="true" tabindex="-1"></a>    mat <span class="sc">%&gt;%</span> </span>
<span id="cb38-24"><a href="models.html#cb38-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">as.data.frame</span>(<span class="fu">as.table</span>(mat)) <span class="sc">%&gt;%</span></span>
<span id="cb38-25"><a href="models.html#cb38-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">True =</span> Var1, <span class="at">Pred =</span> Var2, <span class="at">Proportion =</span> Freq) <span class="sc">%&gt;%</span></span>
<span id="cb38-26"><a href="models.html#cb38-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">Label =</span> label,</span>
<span id="cb38-27"><a href="models.html#cb38-27" aria-hidden="true" tabindex="-1"></a>             <span class="at">Model =</span> model_id)</span>
<span id="cb38-28"><a href="models.html#cb38-28" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb38-29"><a href="models.html#cb38-29" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb38-30"><a href="models.html#cb38-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-31"><a href="models.html#cb38-31" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(conf_df) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="models.html#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(conf_df, <span class="fu">aes</span>(<span class="at">x =</span> Pred, <span class="at">y =</span> True, <span class="at">fill =</span> Proportion)) <span class="sc">+</span></span>
<span id="cb39-2"><a href="models.html#cb39-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">color =</span> <span class="st">&quot;white&quot;</span>) <span class="sc">+</span></span>
<span id="cb39-3"><a href="models.html#cb39-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient</span>(<span class="at">low =</span> <span class="st">&quot;white&quot;</span>, <span class="at">high =</span> <span class="st">&quot;#08519c&quot;</span>) <span class="sc">+</span></span>
<span id="cb39-4"><a href="models.html#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(Label <span class="sc">~</span> Model) <span class="sc">+</span></span>
<span id="cb39-5"><a href="models.html#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_text</span>(<span class="fu">aes</span>(<span class="at">label =</span> <span class="fu">round</span>(Proportion, <span class="dv">2</span>)), <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb39-6"><a href="models.html#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Predicted Class&quot;</span>,</span>
<span id="cb39-7"><a href="models.html#cb39-7" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;True Class&quot;</span>,</span>
<span id="cb39-8"><a href="models.html#cb39-8" aria-hidden="true" tabindex="-1"></a>       <span class="at">fill =</span> <span class="st">&quot;Proportion&quot;</span>) <span class="sc">+</span></span>
<span id="cb39-9"><a href="models.html#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb39-10"><a href="models.html#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb39-11"><a href="models.html#cb39-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>),</span>
<span id="cb39-12"><a href="models.html#cb39-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">11</span>),</span>
<span id="cb39-13"><a href="models.html#cb39-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">panel.grid =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb39-14"><a href="models.html#cb39-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&#39;black&#39;</span>),</span>
<span id="cb39-15"><a href="models.html#cb39-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text.y =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&#39;black&#39;</span>))</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<blockquote>
<p>Only <code>heat_1h</code> behaved like a as a desired model: consistent, predictable, and easy to classify. The other conditions, especially anything drought-related, turned out to be more… dramatic. In many cases, models predicted everything as positive. That’s great for recall, but not so great for precision or balanced accuracy. Basically: if the model always say “0” or “1” it is not technically wrong, but it is not very helpful either.</p>
</blockquote>
</div>
<div id="performance-metrics-and-roc-curves" class="section level3 hasAnchor" number="7.1.2">
<h3><span class="header-section-number">7.1.2</span> Performance Metrics and ROC Curves<a href="models.html#performance-metrics-and-roc-curves" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Each model was evaluated using four metrics: <strong>Balanced Accuracy, F1-Score, Precision, and Recall</strong>.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="models.html#cb40-1" aria-hidden="true" tabindex="-1"></a>compute_metrics <span class="ot">&lt;-</span> <span class="cf">function</span>(obs, pred) {</span>
<span id="cb40-2"><a href="models.html#cb40-2" aria-hidden="true" tabindex="-1"></a>  cm <span class="ot">&lt;-</span> <span class="fu">confusionMatrix</span>(<span class="fu">factor</span>(pred), <span class="fu">factor</span>(obs), <span class="at">positive =</span> <span class="st">&quot;1&quot;</span>)</span>
<span id="cb40-3"><a href="models.html#cb40-3" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> cm<span class="sc">$</span>byClass[<span class="fu">c</span>(<span class="st">&quot;Balanced Accuracy&quot;</span>, <span class="st">&quot;F1&quot;</span>, <span class="st">&quot;Precision&quot;</span>, <span class="st">&quot;Recall&quot;</span>)]</span>
<span id="cb40-4"><a href="models.html#cb40-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-5"><a href="models.html#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.list</span>(out))</span>
<span id="cb40-6"><a href="models.html#cb40-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-7"><a href="models.html#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="models.html#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Test metrics</span></span>
<span id="cb40-9"><a href="models.html#cb40-9" aria-hidden="true" tabindex="-1"></a>test_metrics <span class="ot">&lt;-</span> <span class="fu">map_dfr</span>(<span class="fu">names</span>(RF_final<span class="sc">$</span>test), <span class="cf">function</span>(label) {</span>
<span id="cb40-10"><a href="models.html#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">map_dfr</span>(RF_final<span class="sc">$</span>test[[label]], <span class="cf">function</span>(model) {</span>
<span id="cb40-11"><a href="models.html#cb40-11" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">compute_metrics</span>(model<span class="sc">$</span>observed, model<span class="sc">$</span>predictions)</span>
<span id="cb40-12"><a href="models.html#cb40-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(<span class="at">Label =</span> label,</span>
<span id="cb40-13"><a href="models.html#cb40-13" aria-hidden="true" tabindex="-1"></a>           <span class="at">mtry =</span> model<span class="sc">$</span>mtry,</span>
<span id="cb40-14"><a href="models.html#cb40-14" aria-hidden="true" tabindex="-1"></a>           <span class="at">nodesize =</span> model<span class="sc">$</span>nodesize,</span>
<span id="cb40-15"><a href="models.html#cb40-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">Phase =</span> <span class="st">&quot;test&quot;</span>,</span>
<span id="cb40-16"><a href="models.html#cb40-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">BalancedAccuracy =</span> m<span class="sc">$</span><span class="st">`</span><span class="at">Balanced Accuracy</span><span class="st">`</span>,</span>
<span id="cb40-17"><a href="models.html#cb40-17" aria-hidden="true" tabindex="-1"></a>           <span class="at">F1 =</span> m<span class="sc">$</span>F1,</span>
<span id="cb40-18"><a href="models.html#cb40-18" aria-hidden="true" tabindex="-1"></a>           <span class="at">Precision =</span> m<span class="sc">$</span>Precision,</span>
<span id="cb40-19"><a href="models.html#cb40-19" aria-hidden="true" tabindex="-1"></a>           <span class="at">Recall =</span> m<span class="sc">$</span>Recall)</span>
<span id="cb40-20"><a href="models.html#cb40-20" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb40-21"><a href="models.html#cb40-21" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb40-22"><a href="models.html#cb40-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-23"><a href="models.html#cb40-23" aria-hidden="true" tabindex="-1"></a>test_metrics <span class="ot">&lt;-</span> test_metrics <span class="sc">%&gt;%</span></span>
<span id="cb40-24"><a href="models.html#cb40-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Label, mtry, nodesize, BalancedAccuracy, F1, Precision, Recall) <span class="sc">%&gt;%</span></span>
<span id="cb40-25"><a href="models.html#cb40-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(BalancedAccuracy, F1, Precision, Recall),</span>
<span id="cb40-26"><a href="models.html#cb40-26" aria-hidden="true" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;Metric&quot;</span>, <span class="at">values_to =</span> <span class="st">&quot;Value&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="models.html#cb41-1" aria-hidden="true" tabindex="-1"></a>plot_met <span class="ot">&lt;-</span></span>
<span id="cb41-2"><a href="models.html#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(test_metrics, <span class="fu">aes</span>(<span class="at">x =</span> Metric, <span class="at">y =</span> Value,</span>
<span id="cb41-3"><a href="models.html#cb41-3" aria-hidden="true" tabindex="-1"></a>                      <span class="at">group =</span> <span class="fu">interaction</span>(mtry, nodesize),</span>
<span id="cb41-4"><a href="models.html#cb41-4" aria-hidden="true" tabindex="-1"></a>                      <span class="at">color =</span> <span class="fu">factor</span>(nodesize),</span>
<span id="cb41-5"><a href="models.html#cb41-5" aria-hidden="true" tabindex="-1"></a>                      <span class="at">linetype =</span> <span class="fu">factor</span>(mtry))) <span class="sc">+</span></span>
<span id="cb41-6"><a href="models.html#cb41-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> .<span class="dv">7</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb41-7"><a href="models.html#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">2</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb41-8"><a href="models.html#cb41-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Label, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb41-9"><a href="models.html#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb41-10"><a href="models.html#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;Score&quot;</span>, <span class="at">x =</span> <span class="st">&#39;&#39;</span>,</span>
<span id="cb41-11"><a href="models.html#cb41-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;Nodesize&quot;</span>,</span>
<span id="cb41-12"><a href="models.html#cb41-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">linetype =</span> <span class="st">&quot;Mtry&quot;</span>) <span class="sc">+</span></span>
<span id="cb41-13"><a href="models.html#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb41-14"><a href="models.html#cb41-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&#39;black&#39;</span>),</span>
<span id="cb41-15"><a href="models.html#cb41-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">legend.position =</span> <span class="st">&#39;none&#39;</span>) <span class="sc">+</span></span>
<span id="cb41-16"><a href="models.html#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#233d4d&#39;</span>, <span class="st">&#39;#fe7f2d&#39;</span>, <span class="st">&#39;#83c5be&#39;</span>)) <span class="sc">+</span></span>
<span id="cb41-17"><a href="models.html#cb41-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;500&quot;</span> <span class="ot">=</span> <span class="st">&quot;solid&quot;</span>, <span class="st">&quot;1000&quot;</span> <span class="ot">=</span> <span class="st">&quot;dashed&quot;</span>, <span class="st">&quot;13491&quot;</span> <span class="ot">=</span> <span class="st">&quot;dotted&quot;</span>)) </span></code></pre></div>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="models.html#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pROC)</span>
<span id="cb42-2"><a href="models.html#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tibble)</span>
<span id="cb42-3"><a href="models.html#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="models.html#cb42-4" aria-hidden="true" tabindex="-1"></a>roc_all <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">names</span>(RF_final<span class="sc">$</span>test), <span class="cf">function</span>(label) {</span>
<span id="cb42-5"><a href="models.html#cb42-5" aria-hidden="true" tabindex="-1"></a>  models <span class="ot">&lt;-</span> RF_final<span class="sc">$</span>test[[label]]</span>
<span id="cb42-6"><a href="models.html#cb42-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-7"><a href="models.html#cb42-7" aria-hidden="true" tabindex="-1"></a>  rocs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="fu">seq_along</span>(models), <span class="cf">function</span>(i) {</span>
<span id="cb42-8"><a href="models.html#cb42-8" aria-hidden="true" tabindex="-1"></a>    x <span class="ot">&lt;-</span> models[[i]]</span>
<span id="cb42-9"><a href="models.html#cb42-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-10"><a href="models.html#cb42-10" aria-hidden="true" tabindex="-1"></a>    r <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb42-11"><a href="models.html#cb42-11" aria-hidden="true" tabindex="-1"></a>      roc_obj <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="at">response =</span> x<span class="sc">$</span>observed,</span>
<span id="cb42-12"><a href="models.html#cb42-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">predictor =</span> x<span class="sc">$</span>predicted_prob,</span>
<span id="cb42-13"><a href="models.html#cb42-13" aria-hidden="true" tabindex="-1"></a>                     <span class="at">quiet =</span> <span class="cn">TRUE</span>,</span>
<span id="cb42-14"><a href="models.html#cb42-14" aria-hidden="true" tabindex="-1"></a>                     <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb42-15"><a href="models.html#cb42-15" aria-hidden="true" tabindex="-1"></a>                     <span class="at">direction =</span> <span class="st">&quot;&lt;&quot;</span>)</span>
<span id="cb42-16"><a href="models.html#cb42-16" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb42-17"><a href="models.html#cb42-17" aria-hidden="true" tabindex="-1"></a>      <span class="fu">tibble</span>(<span class="at">Label =</span> label,</span>
<span id="cb42-18"><a href="models.html#cb42-18" aria-hidden="true" tabindex="-1"></a>             <span class="at">mtry =</span> x<span class="sc">$</span>mtry,</span>
<span id="cb42-19"><a href="models.html#cb42-19" aria-hidden="true" tabindex="-1"></a>             <span class="at">nodesize =</span> x<span class="sc">$</span>nodesize,</span>
<span id="cb42-20"><a href="models.html#cb42-20" aria-hidden="true" tabindex="-1"></a>             <span class="at">specificity =</span> <span class="fu">rev</span>(roc_obj<span class="sc">$</span>specificities),</span>
<span id="cb42-21"><a href="models.html#cb42-21" aria-hidden="true" tabindex="-1"></a>             <span class="at">sensitivity =</span> <span class="fu">rev</span>(roc_obj<span class="sc">$</span>sensitivities),</span>
<span id="cb42-22"><a href="models.html#cb42-22" aria-hidden="true" tabindex="-1"></a>             <span class="at">auc =</span> <span class="fu">as.numeric</span>(<span class="fu">auc</span>(roc_obj)),</span>
<span id="cb42-23"><a href="models.html#cb42-23" aria-hidden="true" tabindex="-1"></a>             <span class="at">model_id =</span> <span class="fu">paste0</span>(<span class="st">&quot;mtry=&quot;</span>, x<span class="sc">$</span>mtry, <span class="st">&quot;_nodesize=&quot;</span>, x<span class="sc">$</span>nodesize))</span>
<span id="cb42-24"><a href="models.html#cb42-24" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb42-25"><a href="models.html#cb42-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-26"><a href="models.html#cb42-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(r)</span>
<span id="cb42-27"><a href="models.html#cb42-27" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb42-28"><a href="models.html#cb42-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-29"><a href="models.html#cb42-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(rocs)</span>
<span id="cb42-30"><a href="models.html#cb42-30" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb42-31"><a href="models.html#cb42-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-32"><a href="models.html#cb42-32" aria-hidden="true" tabindex="-1"></a>roc_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(roc_all)</span>
<span id="cb42-33"><a href="models.html#cb42-33" aria-hidden="true" tabindex="-1"></a>roc_df <span class="ot">&lt;-</span> <span class="fu">mutate</span>(roc_df,</span>
<span id="cb42-34"><a href="models.html#cb42-34" aria-hidden="true" tabindex="-1"></a>                 <span class="at">mtry =</span> <span class="fu">as.factor</span>(mtry),</span>
<span id="cb42-35"><a href="models.html#cb42-35" aria-hidden="true" tabindex="-1"></a>                 <span class="at">nodesize =</span> <span class="fu">as.factor</span>(nodesize))</span></code></pre></div>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="models.html#cb43-1" aria-hidden="true" tabindex="-1"></a>plot_roc <span class="ot">&lt;-</span></span>
<span id="cb43-2"><a href="models.html#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(roc_df, <span class="fu">aes</span>(<span class="at">x =</span> <span class="dv">1</span> <span class="sc">-</span> specificity, </span>
<span id="cb43-3"><a href="models.html#cb43-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">y =</span> sensitivity, </span>
<span id="cb43-4"><a href="models.html#cb43-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">color =</span> <span class="fu">factor</span>(nodesize), </span>
<span id="cb43-5"><a href="models.html#cb43-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">linetype =</span> <span class="fu">factor</span>(mtry))) <span class="sc">+</span></span>
<span id="cb43-6"><a href="models.html#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">linewidth =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb43-7"><a href="models.html#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Label, <span class="at">ncol =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb43-8"><a href="models.html#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>() <span class="sc">+</span></span>
<span id="cb43-9"><a href="models.html#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;False Positive Rate&quot;</span>,</span>
<span id="cb43-10"><a href="models.html#cb43-10" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;True Positive Rate&quot;</span>,</span>
<span id="cb43-11"><a href="models.html#cb43-11" aria-hidden="true" tabindex="-1"></a>       <span class="at">color =</span> <span class="st">&quot;nodesize&quot;</span>,</span>
<span id="cb43-12"><a href="models.html#cb43-12" aria-hidden="true" tabindex="-1"></a>       <span class="at">linetype =</span> <span class="st">&quot;mtry&quot;</span>) <span class="sc">+</span></span>
<span id="cb43-13"><a href="models.html#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&#39;#233d4d&#39;</span>, <span class="st">&#39;#fe7f2d&#39;</span>, <span class="st">&#39;#83c5be&#39;</span>)) <span class="sc">+</span></span>
<span id="cb43-14"><a href="models.html#cb43-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_linetype_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;500&quot;</span> <span class="ot">=</span> <span class="st">&quot;solid&quot;</span>, <span class="st">&quot;1000&quot;</span> <span class="ot">=</span> <span class="st">&quot;dashed&quot;</span>, <span class="st">&quot;13491&quot;</span> <span class="ot">=</span> <span class="st">&quot;dotted&quot;</span>)) <span class="sc">+</span></span>
<span id="cb43-15"><a href="models.html#cb43-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">color =</span> <span class="st">&#39;black&#39;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="models.html#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gridExtra)</span></code></pre></div>
<pre><code>## 
## Attaching package: &#39;gridExtra&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:dplyr&#39;:
## 
##     combine</code></pre>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="models.html#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(grid)</span>
<span id="cb47-2"><a href="models.html#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="models.html#cb47-3" aria-hidden="true" tabindex="-1"></a>g1 <span class="ot">&lt;-</span> <span class="fu">ggplotGrob</span>(plot_met)</span>
<span id="cb47-4"><a href="models.html#cb47-4" aria-hidden="true" tabindex="-1"></a>g2 <span class="ot">&lt;-</span> <span class="fu">ggplotGrob</span>(plot_roc)</span>
<span id="cb47-5"><a href="models.html#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="models.html#cb47-6" aria-hidden="true" tabindex="-1"></a>max_height <span class="ot">&lt;-</span> grid<span class="sc">::</span><span class="fu">unit.pmax</span>(g1<span class="sc">$</span>heights, g2<span class="sc">$</span>heights)</span>
<span id="cb47-7"><a href="models.html#cb47-7" aria-hidden="true" tabindex="-1"></a>g1<span class="sc">$</span>heights <span class="ot">&lt;-</span> max_height</span>
<span id="cb47-8"><a href="models.html#cb47-8" aria-hidden="true" tabindex="-1"></a>g2<span class="sc">$</span>heights <span class="ot">&lt;-</span> max_height</span>
<span id="cb47-9"><a href="models.html#cb47-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-10"><a href="models.html#cb47-10" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(g1, g2, <span class="at">ncol =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
<blockquote>
<p>Once again, <code>heat_1h</code> attract attention with high and stable performance across the board. Drought conditions, on the other hand, gave the models a hard time, often pushing them into the “just predict one class and hope for the best” corner. The result? <strong>High recall, but poor precision and disappointing F1-scores</strong>. <code>heat_6h</code> sat somewhere in the middle: still sensitive, but less specific.</p>
<p>These patterns suggest that early heat stress triggers a clear and strong transcriptomic response, easily picked up at the k-mer level. Drought, however, might be slower to kick in or more tangled with noise, making it harder to pin down with the current approach.</p>
</blockquote>
</div>
<div id="important-k-mers-associated-with-heat-stress-1h" class="section level3 hasAnchor" number="7.1.3">
<h3><span class="header-section-number">7.1.3</span> Important k-mers associated with heat stress (1h)<a href="models.html#important-k-mers-associated-with-heat-stress-1h" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To look behind the scenes and see which sequences were pulling the strings, I extracted the top 20 k-mers ranked by <strong>Mean Decrease in Gini</strong> from the best-performing Random Forest trained on <code>heat_1h.</code></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="models.html#cb48-1" aria-hidden="true" tabindex="-1"></a>best_model <span class="ot">&lt;-</span> RF_final<span class="sc">$</span>test[[<span class="st">&quot;heat_1h&quot;</span>]][[<span class="fu">which.max</span>(<span class="fu">sapply</span>(RF_final<span class="sc">$</span>test[[<span class="st">&quot;heat_1h&quot;</span>]], <span class="cf">function</span>(x) x<span class="sc">$</span>acc))]]<span class="sc">$</span>model</span>
<span id="cb48-2"><a href="models.html#cb48-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-3"><a href="models.html#cb48-3" aria-hidden="true" tabindex="-1"></a>imp <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(best_model<span class="sc">$</span>importance)</span>
<span id="cb48-4"><a href="models.html#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="models.html#cb48-5" aria-hidden="true" tabindex="-1"></a>imp_kmers <span class="ot">&lt;-</span> imp <span class="sc">%&gt;%</span></span>
<span id="cb48-6"><a href="models.html#cb48-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">&quot;kmer&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-7"><a href="models.html#cb48-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kmer <span class="sc">!=</span> <span class="st">&quot;control&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb48-8"><a href="models.html#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(MeanDecreaseGini))</span>
<span id="cb48-9"><a href="models.html#cb48-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-10"><a href="models.html#cb48-10" aria-hidden="true" tabindex="-1"></a>top_kmers <span class="ot">&lt;-</span> imp_kmers <span class="sc">%&gt;%</span> <span class="fu">slice_max</span>(MeanDecreaseGini, <span class="at">n =</span> <span class="dv">20</span>)</span>
<span id="cb48-11"><a href="models.html#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="models.html#cb48-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(top_kmers, <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(kmer, MeanDecreaseGini), <span class="at">y =</span> MeanDecreaseGini)) <span class="sc">+</span></span>
<span id="cb48-13"><a href="models.html#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">fill =</span> <span class="st">&quot;steelblue&quot;</span>) <span class="sc">+</span></span>
<span id="cb48-14"><a href="models.html#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb48-15"><a href="models.html#cb48-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">12</span>) <span class="sc">+</span></span>
<span id="cb48-16"><a href="models.html#cb48-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;k-mer (41-mer)&quot;</span>,</span>
<span id="cb48-17"><a href="models.html#cb48-17" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="st">&quot;Mean Decrease in Gini&quot;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
<blockquote>
<p>**Unfortunately, I didn’t have time to validate whether these star k-mers actually map to known genes or differentially expressed regions. And I’m genuinely frustrated about that. It would have made the story stronger, more complete and biologically grounded. That said, these k-mers are ready for follow-up work: alignment to reference transcripts, GO enrichment, or anything else that helps explain why the model liked them so much. If I had more time, this would absolutely be next.</p>
</blockquote>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="exploratory-analysis.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/06_Models.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
},
"self_contained": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
