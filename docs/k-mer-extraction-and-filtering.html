<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 K-mer Extraction and Filtering | Models</title>
  <meta name="description" content="This report covers all classes from PLPTH 820 course." />
  <meta name="generator" content="bookdown 0.42 and GitBook 2.6.7" />

  <meta property="og:title" content="5 K-mer Extraction and Filtering | Models" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This report covers all classes from PLPTH 820 course." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 K-mer Extraction and Filtering | Models" />
  
  <meta name="twitter:description" content="This report covers all classes from PLPTH 820 course." />
  

<meta name="author" content="Gabriela Romero Campos" />


<meta name="date" content="2025-05-14" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="pseudosamples-from-raw-reads.html"/>
<link rel="next" href="exploratory-analysis.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<script src="libs/plotly-binding-4.10.0/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">AGRO 920</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About</a>
<ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#data"><i class="fa fa-check"></i><b>1.1</b> Data</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#project-overview"><i class="fa fa-check"></i><b>1.2</b> Project Overview</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="index.html"><a href="index.html#objective"><i class="fa fa-check"></i><b>1.2.1</b> Objective</a></li>
<li class="chapter" data-level="1.2.2" data-path="index.html"><a href="index.html#why-k-mers"><i class="fa fa-check"></i><b>1.2.2</b> Why k-mers?</a></li>
<li class="chapter" data-level="1.2.3" data-path="index.html"><a href="index.html#why-pseudo-samples-ps"><i class="fa fa-check"></i><b>1.2.3</b> Why pseudo-samples (PS)?</a></li>
<li class="chapter" data-level="1.2.4" data-path="index.html"><a href="index.html#why-machine-learning"><i class="fa fa-check"></i><b>1.2.4</b> Why machine learning?</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="data-acquisition.html"><a href="data-acquisition.html"><i class="fa fa-check"></i><b>2</b> Data Acquisition</a>
<ul>
<li class="chapter" data-level="2.1" data-path="data-acquisition.html"><a href="data-acquisition.html#download"><i class="fa fa-check"></i><b>2.1</b> Download</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="quality-control.html"><a href="quality-control.html"><i class="fa fa-check"></i><b>3</b> Quality Control</a>
<ul>
<li class="chapter" data-level="3.1" data-path="quality-control.html"><a href="quality-control.html#fastqc-and-multiqc"><i class="fa fa-check"></i><b>3.1</b> FastQC and MultiQC</a></li>
<li class="chapter" data-level="3.2" data-path="quality-control.html"><a href="quality-control.html#duplicate-removal-with-markduplicates"><i class="fa fa-check"></i><b>3.2</b> Duplicate Removal with MarkDuplicates</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="pseudosamples-from-raw-reads.html"><a href="pseudosamples-from-raw-reads.html"><i class="fa fa-check"></i><b>4</b> Pseudosamples from Raw Reads</a>
<ul>
<li class="chapter" data-level="4.1" data-path="pseudosamples-from-raw-reads.html"><a href="pseudosamples-from-raw-reads.html#merge-paired-end-reads-into-a-single-fasta"><i class="fa fa-check"></i><b>4.1</b> Merge Paired-end Reads into a Single FASTA</a></li>
<li class="chapter" data-level="4.2" data-path="pseudosamples-from-raw-reads.html"><a href="pseudosamples-from-raw-reads.html#split-into-pseudosamples"><i class="fa fa-check"></i><b>4.2</b> Split into Pseudosamples</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html"><i class="fa fa-check"></i><b>5</b> K-mer Extraction and Filtering</a>
<ul>
<li class="chapter" data-level="5.1" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#k-mer-counting-with-jellyfish"><i class="fa fa-check"></i><b>5.1</b> K-mer Counting with Jellyfish</a></li>
<li class="chapter" data-level="5.2" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#pseudosample-merging-by-treatment"><i class="fa fa-check"></i><b>5.2</b> Pseudosample Merging by Treatment</a></li>
<li class="chapter" data-level="5.3" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#global-merging-by-group"><i class="fa fa-check"></i><b>5.3</b> Global Merging by Group</a></li>
<li class="chapter" data-level="5.4" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#aggregation-and-total-count-per-k-mer"><i class="fa fa-check"></i><b>5.4</b> Aggregation and Total Count per K-mer</a></li>
<li class="chapter" data-level="5.5" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#filtering-kmers"><i class="fa fa-check"></i><b>5.5</b> Filtering kmers</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#step-1-abundance-threshold"><i class="fa fa-check"></i><b>5.5.1</b> Step 1: Abundance Threshold</a></li>
<li class="chapter" data-level="5.5.2" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#step-2-coefficient-of-variation-cv"><i class="fa fa-check"></i><b>5.5.2</b> Step 2: Coefficient of Variation (CV)</a></li>
<li class="chapter" data-level="5.5.3" data-path="k-mer-extraction-and-filtering.html"><a href="k-mer-extraction-and-filtering.html#step-3-redundancy-removal-with-cd-hit-est"><i class="fa fa-check"></i><b>5.5.3</b> Step 3: Redundancy Removal with CD-HIT-EST</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html"><i class="fa fa-check"></i><b>6</b> Exploratory Analysis</a>
<ul>
<li class="chapter" data-level="6.1" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#total-counts"><i class="fa fa-check"></i><b>6.1</b> Total counts</a></li>
<li class="chapter" data-level="6.2" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#variance"><i class="fa fa-check"></i><b>6.2</b> Variance</a></li>
<li class="chapter" data-level="6.3" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#pca"><i class="fa fa-check"></i><b>6.3</b> PCA</a></li>
<li class="chapter" data-level="6.4" data-path="exploratory-analysis.html"><a href="exploratory-analysis.html#t-sne"><i class="fa fa-check"></i><b>6.4</b> t-SNE</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="models.html"><a href="models.html"><i class="fa fa-check"></i><b>7</b> Models</a>
<ul>
<li class="chapter" data-level="7.1" data-path="models.html"><a href="models.html#random-forest"><i class="fa fa-check"></i><b>7.1</b> Random Forest</a>
<ul>
<li class="chapter" data-level="7.1.1" data-path="models.html"><a href="models.html#confusion-matrices"><i class="fa fa-check"></i><b>7.1.1</b> Confusion Matrices</a></li>
<li class="chapter" data-level="7.1.2" data-path="models.html"><a href="models.html#performance-metrics-and-roc-curves"><i class="fa fa-check"></i><b>7.1.2</b> Performance Metrics and ROC Curves</a></li>
<li class="chapter" data-level="7.1.3" data-path="models.html"><a href="models.html#important-k-mers-associated-with-heat-stress-1h"><i class="fa fa-check"></i><b>7.1.3</b> Important k-mers associated with heat stress (1h)</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Models</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="k-mer-extraction-and-filtering" class="section level1 hasAnchor" number="5">
<h1><span class="header-section-number">5</span> K-mer Extraction and Filtering<a href="k-mer-extraction-and-filtering.html#k-mer-extraction-and-filtering" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>To quantify sequence patterns across pseudo-samples without depending on a reference genome, I extracted 41-mers directly from raw reads using Jellyfish. This section outlines the full process of counting, filtering, and condensing millions of k-mers into something the models could actually handle.</p>
<div id="k-mer-counting-with-jellyfish" class="section level2 hasAnchor" number="5.1">
<h2><span class="header-section-number">5.1</span> K-mer Counting with Jellyfish<a href="k-mer-extraction-and-filtering.html#k-mer-counting-with-jellyfish" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Jellyfish v2.3.0 was used to count canonical <strong>41-mers</strong> from each pseudosample FASTA file. To avoid getting distracted by sequencing noise, only k-mers with frequency &gt;= 10 were kept. The pipeline used a two-pass system: A filter was used to identify promising k-mer candidates, followed by a targeted recount of those that appeared frequently.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="k-mer-extraction-and-filtering.html#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb7-2"><a href="k-mer-extraction-and-filtering.html#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=kmer_count</span></span>
<span id="cb7-3"><a href="k-mer-extraction-and-filtering.html#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=7-00:00:00</span></span>
<span id="cb7-4"><a href="k-mer-extraction-and-filtering.html#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0-1399%100   </span></span>
<span id="cb7-5"><a href="k-mer-extraction-and-filtering.html#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=25G</span></span>
<span id="cb7-6"><a href="k-mer-extraction-and-filtering.html#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=10</span></span>
<span id="cb7-7"><a href="k-mer-extraction-and-filtering.html#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="k-mer-extraction-and-filtering.html#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load Jellyfish/2.3.0-GCC-11.3.0</span>
<span id="cb7-9"><a href="k-mer-extraction-and-filtering.html#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="k-mer-extraction-and-filtering.html#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Job started on </span><span class="va">$(</span><span class="fu">date</span><span class="va">)</span><span class="st">&quot;</span></span>
<span id="cb7-11"><a href="k-mer-extraction-and-filtering.html#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="k-mer-extraction-and-filtering.html#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Generate a list of all pseudo-fasta files</span></span>
<span id="cb7-13"><a href="k-mer-extraction-and-filtering.html#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">&quot;</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="st">&quot;</span> <span class="ot">-eq</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb7-14"><a href="k-mer-extraction-and-filtering.html#cb7-14" aria-hidden="true" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">&quot;Generating list of pseudo-fasta files...&quot;</span></span>
<span id="cb7-15"><a href="k-mer-extraction-and-filtering.html#cb7-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">find</span> ps_fasta <span class="at">-type</span> f <span class="at">-name</span> <span class="st">&quot;*_ps*.fasta&quot;</span> <span class="kw">|</span> <span class="fu">sort</span> <span class="op">&gt;</span> all_pseudo_fastas.list</span>
<span id="cb7-16"><a href="k-mer-extraction-and-filtering.html#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb7-17"><a href="k-mer-extraction-and-filtering.html#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="k-mer-extraction-and-filtering.html#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="fu">sleep</span> 10</span>
<span id="cb7-19"><a href="k-mer-extraction-and-filtering.html#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="k-mer-extraction-and-filtering.html#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: file path </span></span>
<span id="cb7-21"><a href="k-mer-extraction-and-filtering.html#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="va">FASTA</span><span class="op">=</span><span class="va">$(</span><span class="fu">sed</span> <span class="at">-n</span> <span class="st">&quot;</span><span class="va">$((SLURM_ARRAY_TASK_ID</span> <span class="op">+</span> <span class="dv">1</span><span class="va">))</span><span class="st">p&quot;</span> all_pseudo_fastas.list<span class="va">)</span></span>
<span id="cb7-22"><a href="k-mer-extraction-and-filtering.html#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="va">BASENAME</span><span class="op">=</span><span class="va">$(</span><span class="fu">basename</span> <span class="st">&quot;</span><span class="va">$FASTA</span><span class="st">&quot;</span> .fasta<span class="va">)</span></span>
<span id="cb7-23"><a href="k-mer-extraction-and-filtering.html#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="va">DIRNAME</span><span class="op">=</span><span class="va">$(</span><span class="fu">dirname</span> <span class="st">&quot;</span><span class="va">$FASTA</span><span class="st">&quot;</span><span class="va">)</span></span>
<span id="cb7-24"><a href="k-mer-extraction-and-filtering.html#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="k-mer-extraction-and-filtering.html#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Processing: </span><span class="va">$FASTA</span><span class="st">&quot;</span></span>
<span id="cb7-26"><a href="k-mer-extraction-and-filtering.html#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="k-mer-extraction-and-filtering.html#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 3: Define output file paths</span></span>
<span id="cb7-28"><a href="k-mer-extraction-and-filtering.html#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="va">BCFILE</span><span class="op">=</span><span class="st">&quot;</span><span class="va">${DIRNAME}</span><span class="st">/</span><span class="va">${BASENAME}</span><span class="st">.bc&quot;</span></span>
<span id="cb7-29"><a href="k-mer-extraction-and-filtering.html#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="va">JFFILE</span><span class="op">=</span><span class="st">&quot;</span><span class="va">${DIRNAME}</span><span class="st">/</span><span class="va">${BASENAME}</span><span class="st">.jf&quot;</span></span>
<span id="cb7-30"><a href="k-mer-extraction-and-filtering.html#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="va">TSVFILE</span><span class="op">=</span><span class="st">&quot;</span><span class="va">${DIRNAME}</span><span class="st">/</span><span class="va">${BASENAME}</span><span class="st">_k41.tsv&quot;</span></span>
<span id="cb7-31"><a href="k-mer-extraction-and-filtering.html#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="k-mer-extraction-and-filtering.html#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 4: First pass - Bloom Counter</span></span>
<span id="cb7-33"><a href="k-mer-extraction-and-filtering.html#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="ex">jellyfish</span> bc <span class="at">-m</span> 41 <span class="at">-s</span> 300M <span class="at">-t</span> 10 <span class="at">-o</span> <span class="st">&quot;</span><span class="va">$BCFILE</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$FASTA</span><span class="st">&quot;</span></span>
<span id="cb7-34"><a href="k-mer-extraction-and-filtering.html#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="k-mer-extraction-and-filtering.html#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 5: Second pass - count only k-mers with frequency &gt;= 2</span></span>
<span id="cb7-36"><a href="k-mer-extraction-and-filtering.html#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="ex">jellyfish</span> count <span class="at">-m</span> 41 <span class="at">-s</span> 300M <span class="at">-t</span> 10 <span class="at">--bc</span> <span class="st">&quot;</span><span class="va">$BCFILE</span><span class="st">&quot;</span> <span class="at">-C</span> <span class="at">-o</span> <span class="st">&quot;</span><span class="va">$JFFILE</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$FASTA</span><span class="st">&quot;</span></span>
<span id="cb7-37"><a href="k-mer-extraction-and-filtering.html#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="k-mer-extraction-and-filtering.html#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 6: TSV format -&gt; transformer</span></span>
<span id="cb7-39"><a href="k-mer-extraction-and-filtering.html#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="ex">jellyfish</span> dump <span class="at">-c</span> <span class="st">&quot;</span><span class="va">$JFFILE</span><span class="st">&quot;</span> <span class="op">&gt;</span> <span class="st">&quot;</span><span class="va">$TSVFILE</span><span class="st">&quot;</span></span>
<span id="cb7-40"><a href="k-mer-extraction-and-filtering.html#cb7-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-41"><a href="k-mer-extraction-and-filtering.html#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Finished: </span><span class="va">$TSVFILE</span><span class="st">&quot;</span></span>
<span id="cb7-42"><a href="k-mer-extraction-and-filtering.html#cb7-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-43"><a href="k-mer-extraction-and-filtering.html#cb7-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 7: Rovome temporary Jellyfish files</span></span>
<span id="cb7-44"><a href="k-mer-extraction-and-filtering.html#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> <span class="at">-f</span> <span class="st">&quot;</span><span class="va">$BCFILE</span><span class="st">&quot;</span> <span class="st">&quot;</span><span class="va">$JFFILE</span><span class="st">&quot;</span></span>
<span id="cb7-45"><a href="k-mer-extraction-and-filtering.html#cb7-45" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Temporary files removed: </span><span class="va">$BCFILE</span><span class="st"> and </span><span class="va">$JFFILE</span><span class="st">&quot;</span></span></code></pre></div>
<p><strong>Output:</strong> One <code>.tsv</code> file per pseudosample containing k-mer sequences and their counts. Temporary <code>.jf</code> and <code>.bc</code> files were deleted to conserve space. The <code>.tsv</code> were compressed into the file <code>count.tar.xz</code>.</p>
</div>
<div id="pseudosample-merging-by-treatment" class="section level2 hasAnchor" number="5.2">
<h2><span class="header-section-number">5.2</span> Pseudosample Merging by Treatment<a href="k-mer-extraction-and-filtering.html#pseudosample-merging-by-treatment" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Given the total number of pseudosamples, processing them all at once wasn’t an option (R crashed several times, no matter how much RAM I added) in real time. So, I merged count files in batches of 10 per treatment using <code>csvtk</code>, generating manageable chunks like <code>SRR1542404_00-09.tsv</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="k-mer-extraction-and-filtering.html#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb8-2"><a href="k-mer-extraction-and-filtering.html#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=merge_kmers</span></span>
<span id="cb8-3"><a href="k-mer-extraction-and-filtering.html#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0-13</span></span>
<span id="cb8-4"><a href="k-mer-extraction-and-filtering.html#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=200G</span></span>
<span id="cb8-5"><a href="k-mer-extraction-and-filtering.html#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=12:00:00</span></span>
<span id="cb8-6"><a href="k-mer-extraction-and-filtering.html#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=15</span></span>
<span id="cb8-7"><a href="k-mer-extraction-and-filtering.html#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="k-mer-extraction-and-filtering.html#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># List of treatment IDs (folders)</span></span>
<span id="cb8-9"><a href="k-mer-extraction-and-filtering.html#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="va">TREAT_IDS</span><span class="op">=</span><span class="va">(</span>SRR1542404 SRR1542405 SRR1542406 SRR1542407 SRR1542408 SRR1542409 SRR1542410 SRR1542411 SRR1542412 SRR1542413 SRR1542414 SRR1542415 SRR1542416 SRR1542417<span class="va">)</span></span>
<span id="cb8-10"><a href="k-mer-extraction-and-filtering.html#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="k-mer-extraction-and-filtering.html#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="k-mer-extraction-and-filtering.html#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="va">TREAT_ID</span><span class="op">=</span><span class="va">${TREAT_IDS</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb8-13"><a href="k-mer-extraction-and-filtering.html#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="k-mer-extraction-and-filtering.html#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] Treatment start: </span><span class="va">$TREAT_ID</span><span class="st">&quot;</span></span>
<span id="cb8-15"><a href="k-mer-extraction-and-filtering.html#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="k-mer-extraction-and-filtering.html#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> <span class="va">$TREAT_ID</span></span>
<span id="cb8-17"><a href="k-mer-extraction-and-filtering.html#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="k-mer-extraction-and-filtering.html#cb8-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 1: Fix TSV files</span></span>
<span id="cb8-19"><a href="k-mer-extraction-and-filtering.html#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] Fixing TSV files.&quot;</span></span>
<span id="cb8-20"><a href="k-mer-extraction-and-filtering.html#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> <span class="pp">*</span>.tsv<span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb8-21"><a href="k-mer-extraction-and-filtering.html#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">#insert header before the original first line</span></span>
<span id="cb8-22"><a href="k-mer-extraction-and-filtering.html#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;1s/^/kmer\tcount\n/&#39;</span> <span class="st">&quot;</span><span class="va">$f</span><span class="st">&quot;</span></span>
<span id="cb8-23"><a href="k-mer-extraction-and-filtering.html#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#After line 2, replace first space with tab</span></span>
<span id="cb8-24"><a href="k-mer-extraction-and-filtering.html#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;2,$s/ /\t/&#39;</span> <span class="st">&quot;</span><span class="va">$f</span><span class="st">&quot;</span></span>
<span id="cb8-25"><a href="k-mer-extraction-and-filtering.html#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="cf">done</span></span>
<span id="cb8-26"><a href="k-mer-extraction-and-filtering.html#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="k-mer-extraction-and-filtering.html#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Step 2: Merge all pseudo‐samples ps00…ps99 into a single matrix</span></span>
<span id="cb8-28"><a href="k-mer-extraction-and-filtering.html#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] 00-09.&quot;</span></span>
<span id="cb8-29"><a href="k-mer-extraction-and-filtering.html#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="pp">*</span>_ps{00..09}_k41.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> ../<span class="va">${TREAT_ID}</span>_00-09.tsv</span>
<span id="cb8-30"><a href="k-mer-extraction-and-filtering.html#cb8-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-31"><a href="k-mer-extraction-and-filtering.html#cb8-31" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] 10-19.&quot;</span></span>
<span id="cb8-32"><a href="k-mer-extraction-and-filtering.html#cb8-32" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="pp">*</span>_ps{10..19}_k41.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> ../<span class="va">${TREAT_ID}</span>_10-19.tsv</span>
<span id="cb8-33"><a href="k-mer-extraction-and-filtering.html#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="k-mer-extraction-and-filtering.html#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] 20-29.&quot;</span></span>
<span id="cb8-35"><a href="k-mer-extraction-and-filtering.html#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="pp">*</span>_ps{20..29}_k41.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> ../<span class="va">${TREAT_ID}</span>_20-29.tsv</span>
<span id="cb8-36"><a href="k-mer-extraction-and-filtering.html#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="k-mer-extraction-and-filtering.html#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] 30-39.&quot;</span></span>
<span id="cb8-38"><a href="k-mer-extraction-and-filtering.html#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="pp">*</span>_ps{30..39}_k41.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> ../<span class="va">${TREAT_ID}</span>_30-39.tsv</span>
<span id="cb8-39"><a href="k-mer-extraction-and-filtering.html#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="k-mer-extraction-and-filtering.html#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] 40-49.&quot;</span></span>
<span id="cb8-41"><a href="k-mer-extraction-and-filtering.html#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="pp">*</span>_ps{40..49}_k41.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> ../<span class="va">${TREAT_ID}</span>_40-49.tsv</span>
<span id="cb8-42"><a href="k-mer-extraction-and-filtering.html#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="k-mer-extraction-and-filtering.html#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] 50-59.&quot;</span></span>
<span id="cb8-44"><a href="k-mer-extraction-and-filtering.html#cb8-44" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="pp">*</span>_ps{50..59}_k41.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> ../<span class="va">${TREAT_ID}</span>_50-59.tsv</span>
<span id="cb8-45"><a href="k-mer-extraction-and-filtering.html#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="k-mer-extraction-and-filtering.html#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] 60-69.&quot;</span></span>
<span id="cb8-47"><a href="k-mer-extraction-and-filtering.html#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="pp">*</span>_ps{60..69}_k41.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> ../<span class="va">${TREAT_ID}</span>_60-69.tsv</span>
<span id="cb8-48"><a href="k-mer-extraction-and-filtering.html#cb8-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-49"><a href="k-mer-extraction-and-filtering.html#cb8-49" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] 70-79.&quot;</span></span>
<span id="cb8-50"><a href="k-mer-extraction-and-filtering.html#cb8-50" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="pp">*</span>_ps{70..79}_k41.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> ../<span class="va">${TREAT_ID}</span>_70-79.tsv</span>
<span id="cb8-51"><a href="k-mer-extraction-and-filtering.html#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="k-mer-extraction-and-filtering.html#cb8-52" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] 80-89.&quot;</span></span>
<span id="cb8-53"><a href="k-mer-extraction-and-filtering.html#cb8-53" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="pp">*</span>_ps{80..89}_k41.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> ../<span class="va">${TREAT_ID}</span>_80-89.tsv</span>
<span id="cb8-54"><a href="k-mer-extraction-and-filtering.html#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="k-mer-extraction-and-filtering.html#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] 90-99.&quot;</span></span>
<span id="cb8-56"><a href="k-mer-extraction-and-filtering.html#cb8-56" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="pp">*</span>_ps{90..99}_k41.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> ../<span class="va">${TREAT_ID}</span>_90-99.tsv</span>
<span id="cb8-57"><a href="k-mer-extraction-and-filtering.html#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="k-mer-extraction-and-filtering.html#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Done</span></span>
<span id="cb8-59"><a href="k-mer-extraction-and-filtering.html#cb8-59" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] </span><span class="va">$TREAT_ID</span><span class="st"> completed.&quot;</span></span></code></pre></div>
<blockquote>
<p><strong>Note:</strong> Each treatment resulted in 10 merged files, stored as <code>TREAT_ID_00-09.tsv</code> to <code>TREAT_ID_90-99.tsv</code>.</p>
</blockquote>
</div>
<div id="global-merging-by-group" class="section level2 hasAnchor" number="5.3">
<h2><span class="header-section-number">5.3</span> Global Merging by Group<a href="k-mer-extraction-and-filtering.html#global-merging-by-group" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Even after merging by treatment, the data was still too big for a single R session (or for any mortal RAM configuration under 300 GB). So, treatments were split into two groups, each processed independently. For each group, the 10 treatment files were combined into 10 final matrices named like <code>FINAL_group1_PART.tsv</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="k-mer-extraction-and-filtering.html#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb9-2"><a href="k-mer-extraction-and-filtering.html#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=merge_kmers</span></span>
<span id="cb9-3"><a href="k-mer-extraction-and-filtering.html#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0-9</span></span>
<span id="cb9-4"><a href="k-mer-extraction-and-filtering.html#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=200G</span></span>
<span id="cb9-5"><a href="k-mer-extraction-and-filtering.html#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=12:00:00</span></span>
<span id="cb9-6"><a href="k-mer-extraction-and-filtering.html#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=15</span></span>
<span id="cb9-7"><a href="k-mer-extraction-and-filtering.html#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="k-mer-extraction-and-filtering.html#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="va">PARTS</span><span class="op">=</span><span class="va">(</span>_00-09.tsv _10-19.tsv _20-29.tsv _30-39.tsv _40-49.tsv _50-59.tsv _60-69.tsv _70-79.tsv _80-89.tsv _90-99.tsv<span class="va">)</span></span>
<span id="cb9-9"><a href="k-mer-extraction-and-filtering.html#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="va">PART</span><span class="op">=</span><span class="va">${PARTS</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span></span>
<span id="cb9-10"><a href="k-mer-extraction-and-filtering.html#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="k-mer-extraction-and-filtering.html#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 1&quot;</span></span>
<span id="cb9-12"><a href="k-mer-extraction-and-filtering.html#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;SRR1542404</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542407</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-13"><a href="k-mer-extraction-and-filtering.html#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="k-mer-extraction-and-filtering.html#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 2&quot;</span></span>
<span id="cb9-15"><a href="k-mer-extraction-and-filtering.html#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542409</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-16"><a href="k-mer-extraction-and-filtering.html#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="k-mer-extraction-and-filtering.html#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 3&quot;</span></span>
<span id="cb9-18"><a href="k-mer-extraction-and-filtering.html#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542411</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-19"><a href="k-mer-extraction-and-filtering.html#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="k-mer-extraction-and-filtering.html#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 4&quot;</span></span>
<span id="cb9-21"><a href="k-mer-extraction-and-filtering.html#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542413</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-22"><a href="k-mer-extraction-and-filtering.html#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="k-mer-extraction-and-filtering.html#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 5&quot;</span></span>
<span id="cb9-24"><a href="k-mer-extraction-and-filtering.html#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542415</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-25"><a href="k-mer-extraction-and-filtering.html#cb9-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-26"><a href="k-mer-extraction-and-filtering.html#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 6&quot;</span></span>
<span id="cb9-27"><a href="k-mer-extraction-and-filtering.html#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542416</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-28"><a href="k-mer-extraction-and-filtering.html#cb9-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-29"><a href="k-mer-extraction-and-filtering.html#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;FINAL_group1</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-30"><a href="k-mer-extraction-and-filtering.html#cb9-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-31"><a href="k-mer-extraction-and-filtering.html#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;-----Group 2------&quot;</span></span>
<span id="cb9-32"><a href="k-mer-extraction-and-filtering.html#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 1&quot;</span></span>
<span id="cb9-33"><a href="k-mer-extraction-and-filtering.html#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;SRR1542405</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542406</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-34"><a href="k-mer-extraction-and-filtering.html#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="k-mer-extraction-and-filtering.html#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 2&quot;</span></span>
<span id="cb9-36"><a href="k-mer-extraction-and-filtering.html#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542408</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-37"><a href="k-mer-extraction-and-filtering.html#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="k-mer-extraction-and-filtering.html#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 3&quot;</span></span>
<span id="cb9-39"><a href="k-mer-extraction-and-filtering.html#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542410</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-40"><a href="k-mer-extraction-and-filtering.html#cb9-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-41"><a href="k-mer-extraction-and-filtering.html#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 4&quot;</span></span>
<span id="cb9-42"><a href="k-mer-extraction-and-filtering.html#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542412</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-43"><a href="k-mer-extraction-and-filtering.html#cb9-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-44"><a href="k-mer-extraction-and-filtering.html#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 5&quot;</span></span>
<span id="cb9-45"><a href="k-mer-extraction-and-filtering.html#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542414</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-46"><a href="k-mer-extraction-and-filtering.html#cb9-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-47"><a href="k-mer-extraction-and-filtering.html#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 6&quot;</span></span>
<span id="cb9-48"><a href="k-mer-extraction-and-filtering.html#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join <span class="st">&quot;final</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;SRR1542417</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span></span>
<span id="cb9-49"><a href="k-mer-extraction-and-filtering.html#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="k-mer-extraction-and-filtering.html#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> <span class="st">&quot;final2</span><span class="va">$PART</span><span class="st">&quot;</span> <span class="st">&quot;FINAL_group2</span><span class="va">$PART</span><span class="st">&quot;</span></span></code></pre></div>
<p><strong>Output:</strong> A total of 20 files (10 per group), later converted to <code>.rds</code> format for faster loading in R. The original <code>.tsv</code> files were deleted, and the <code>.rds</code> versions were bundled in <code>kmer_count.tar.xz</code>.</p>
</div>
<div id="aggregation-and-total-count-per-k-mer" class="section level2 hasAnchor" number="5.4">
<h2><span class="header-section-number">5.4</span> Aggregation and Total Count per K-mer<a href="k-mer-extraction-and-filtering.html#aggregation-and-total-count-per-k-mer" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Each final matrix was loaded in R, and total counts per k-mer were computed across all pseudosamples. A <code>.tsv</code> version of the totals was created for external filtering, while the intermediate <code>.rds</code> files were kept for sanity (and speed).</p>
<blockquote>
<p><strong>Note:</strong> All this was done via SLURM jobs, a necessary evil that saved me time.</p>
</blockquote>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="k-mer-extraction-and-filtering.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb10-2"><a href="k-mer-extraction-and-filtering.html#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=kmers</span></span>
<span id="cb10-3"><a href="k-mer-extraction-and-filtering.html#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0-19</span></span>
<span id="cb10-4"><a href="k-mer-extraction-and-filtering.html#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=04:00:00</span></span>
<span id="cb10-5"><a href="k-mer-extraction-and-filtering.html#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=50G</span></span>
<span id="cb10-6"><a href="k-mer-extraction-and-filtering.html#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1</span></span>
<span id="cb10-7"><a href="k-mer-extraction-and-filtering.html#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="k-mer-extraction-and-filtering.html#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load R/4.2.1-foss-2022a</span>
<span id="cb10-9"><a href="k-mer-extraction-and-filtering.html#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="k-mer-extraction-and-filtering.html#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="va">FILES_LIST</span><span class="op">=</span><span class="va">($(</span><span class="fu">ls</span> FINAL_group<span class="pp">*</span>.tsv<span class="va">))</span></span>
<span id="cb10-11"><a href="k-mer-extraction-and-filtering.html#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="va">FILE</span><span class="op">=</span><span class="st">&quot;</span><span class="va">${FILES_LIST</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span><span class="st">&quot;</span></span>
<span id="cb10-12"><a href="k-mer-extraction-and-filtering.html#cb10-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-13"><a href="k-mer-extraction-and-filtering.html#cb10-13" aria-hidden="true" tabindex="-1"></a><span class="ex">R</span> <span class="at">--no-save</span> <span class="at">-q</span> <span class="op">&lt;</span> editFiles1.R <span class="st">&quot;</span><span class="va">$FILE</span><span class="st">&quot;</span></span></code></pre></div>
<ul>
<li>editFiles1.R</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="k-mer-extraction-and-filtering.html#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb11-2"><a href="k-mer-extraction-and-filtering.html#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="k-mer-extraction-and-filtering.html#cb11-3" aria-hidden="true" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="at">trailingOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-4"><a href="k-mer-extraction-and-filtering.html#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(args[<span class="dv">1</span>])</span>
<span id="cb11-5"><a href="k-mer-extraction-and-filtering.html#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="k-mer-extraction-and-filtering.html#cb11-6" aria-hidden="true" tabindex="-1"></a>path_files <span class="ot">&lt;-</span> args[<span class="dv">1</span>]</span>
<span id="cb11-7"><a href="k-mer-extraction-and-filtering.html#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="k-mer-extraction-and-filtering.html#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb11-9"><a href="k-mer-extraction-and-filtering.html#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb11-10"><a href="k-mer-extraction-and-filtering.html#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="k-mer-extraction-and-filtering.html#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&#39;/bulk/eakhunov/grcampos/embeddings/&#39;</span>)</span>
<span id="cb11-12"><a href="k-mer-extraction-and-filtering.html#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="k-mer-extraction-and-filtering.html#cb11-13" aria-hidden="true" tabindex="-1"></a>tmp_mat <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="fu">paste0</span>(<span class="st">&#39;/bulk/eakhunov/grcampos/embeddings/kmer_count/&#39;</span>, path_files))</span>
<span id="cb11-14"><a href="k-mer-extraction-and-filtering.html#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tmp_mat)[<span class="sc">-</span><span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">str_extract</span>(<span class="fu">colnames</span>(tmp_mat)[<span class="sc">-</span><span class="dv">1</span>], <span class="st">&quot;SRR</span><span class="sc">\\</span><span class="st">d+_ps</span><span class="sc">\\</span><span class="st">d+&quot;</span>)</span>
<span id="cb11-15"><a href="k-mer-extraction-and-filtering.html#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="k-mer-extraction-and-filtering.html#cb11-16" aria-hidden="true" tabindex="-1"></a>kmer_check <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">kmer =</span> tmp_mat<span class="sc">$</span>kmer,</span>
<span id="cb11-17"><a href="k-mer-extraction-and-filtering.html#cb11-17" aria-hidden="true" tabindex="-1"></a>                         <span class="at">count =</span> <span class="fu">rowSums</span>(tmp_mat[, <span class="sc">-</span><span class="dv">1</span>, <span class="at">with =</span> <span class="cn">FALSE</span>]))</span>
<span id="cb11-18"><a href="k-mer-extraction-and-filtering.html#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="k-mer-extraction-and-filtering.html#cb11-19" aria-hidden="true" tabindex="-1"></a>name_base <span class="ot">&lt;-</span> tools<span class="sc">::</span><span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(path_files))</span>
<span id="cb11-20"><a href="k-mer-extraction-and-filtering.html#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="k-mer-extraction-and-filtering.html#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(tmp_mat, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;/bulk/eakhunov/grcampos/embeddings/kmer_count/&#39;</span>, name_base, <span class="st">&#39;.rds&#39;</span>))</span>
<span id="cb11-22"><a href="k-mer-extraction-and-filtering.html#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(kmer_check, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;/bulk/eakhunov/grcampos/embeddings/kmer_count/count&#39;</span>, name_base, <span class="st">&#39;.tsv&#39;</span>), <span class="at">quote =</span> F, <span class="at">row.names =</span> F, <span class="at">sep =</span> <span class="st">&#39;</span><span class="sc">\t</span><span class="st">&#39;</span>)</span>
<span id="cb11-23"><a href="k-mer-extraction-and-filtering.html#cb11-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-24"><a href="k-mer-extraction-and-filtering.html#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Done!&#39;</span>)</span></code></pre></div>
</div>
<div id="filtering-kmers" class="section level2 hasAnchor" number="5.5">
<h2><span class="header-section-number">5.5</span> Filtering kmers<a href="k-mer-extraction-and-filtering.html#filtering-kmers" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="step-1-abundance-threshold" class="section level3 hasAnchor" number="5.5.1">
<h3><span class="header-section-number">5.5.1</span> Step 1: Abundance Threshold<a href="k-mer-extraction-and-filtering.html#step-1-abundance-threshold" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First, I filtered out k-mers with total count &lt; 10, reducing the dataset from a dropping ~88 million k-mers to a more reasonable ~45 million. This required recombining all parts into a single matrix (a fun reminder that splitting things helps performance, but reuniting them is unavoidable in the end).</p>
<p>Matrix rows were reordered to align across all files, for consistency across files.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="k-mer-extraction-and-filtering.html#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb12-2"><a href="k-mer-extraction-and-filtering.html#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=merge_count2</span></span>
<span id="cb12-3"><a href="k-mer-extraction-and-filtering.html#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0</span></span>
<span id="cb12-4"><a href="k-mer-extraction-and-filtering.html#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=200G</span></span>
<span id="cb12-5"><a href="k-mer-extraction-and-filtering.html#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=12:00:00</span></span>
<span id="cb12-6"><a href="k-mer-extraction-and-filtering.html#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=15</span></span>
<span id="cb12-7"><a href="k-mer-extraction-and-filtering.html#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="k-mer-extraction-and-filtering.html#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 1&quot;</span></span>
<span id="cb12-9"><a href="k-mer-extraction-and-filtering.html#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join count_00-09.tsv count_10-19.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> FINAL.tsv</span>
<span id="cb12-10"><a href="k-mer-extraction-and-filtering.html#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="k-mer-extraction-and-filtering.html#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 2&quot;</span></span>
<span id="cb12-12"><a href="k-mer-extraction-and-filtering.html#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join FINAL.tsv count_20-39.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> FINAL2.tsv</span>
<span id="cb12-13"><a href="k-mer-extraction-and-filtering.html#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="k-mer-extraction-and-filtering.html#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 3&quot;</span></span>
<span id="cb12-15"><a href="k-mer-extraction-and-filtering.html#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join FINAL2.tsv count_30-39.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> FINAL.tsv</span>
<span id="cb12-16"><a href="k-mer-extraction-and-filtering.html#cb12-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-17"><a href="k-mer-extraction-and-filtering.html#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 4&quot;</span></span>
<span id="cb12-18"><a href="k-mer-extraction-and-filtering.html#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join FINAL.tsv count_40-49.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> FINAL2.tsv</span>
<span id="cb12-19"><a href="k-mer-extraction-and-filtering.html#cb12-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-20"><a href="k-mer-extraction-and-filtering.html#cb12-20" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 5&quot;</span></span>
<span id="cb12-21"><a href="k-mer-extraction-and-filtering.html#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join FINAL2.tsv count_50-59.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> FINAL.tsv</span>
<span id="cb12-22"><a href="k-mer-extraction-and-filtering.html#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="k-mer-extraction-and-filtering.html#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 6&quot;</span></span>
<span id="cb12-24"><a href="k-mer-extraction-and-filtering.html#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join FINAL.tsv count_60-69.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> FINAL2.tsv</span>
<span id="cb12-25"><a href="k-mer-extraction-and-filtering.html#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="k-mer-extraction-and-filtering.html#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 7&quot;</span></span>
<span id="cb12-27"><a href="k-mer-extraction-and-filtering.html#cb12-27" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join FINAL2.tsv count_70-79.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> FINAL.tsv</span>
<span id="cb12-28"><a href="k-mer-extraction-and-filtering.html#cb12-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-29"><a href="k-mer-extraction-and-filtering.html#cb12-29" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 8&quot;</span></span>
<span id="cb12-30"><a href="k-mer-extraction-and-filtering.html#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join FINAL.tsv count_80-89.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> FINAL2.tsv</span>
<span id="cb12-31"><a href="k-mer-extraction-and-filtering.html#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="k-mer-extraction-and-filtering.html#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;[</span><span class="va">$(</span><span class="fu">date</span> <span class="st">&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class="va">)</span><span class="st">] step 9&quot;</span></span>
<span id="cb12-33"><a href="k-mer-extraction-and-filtering.html#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="ex">~/Tools_Scripts/csvtk</span> join FINAL2.tsv count_90-99.tsv <span class="at">-t</span> <span class="at">-f</span> 1 <span class="at">-j</span> 15 <span class="at">--outer-join</span> <span class="at">--na</span> 0 <span class="at">--prefix-filename</span> <span class="at">--prefix-trim-ext</span> <span class="op">&gt;</span> FINAL.tsv</span>
<span id="cb12-34"><a href="k-mer-extraction-and-filtering.html#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="k-mer-extraction-and-filtering.html#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="fu">mv</span> FINAL.tsv kmer_count.tsv</span>
<span id="cb12-36"><a href="k-mer-extraction-and-filtering.html#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span> FINAL2.tsv</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="k-mer-extraction-and-filtering.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load R/4.2.1-foss-2022a</span>
<span id="cb13-2"><a href="k-mer-extraction-and-filtering.html#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="k-mer-extraction-and-filtering.html#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--job-name</span><span class="op">=</span>R <span class="at">--time</span><span class="op">=</span>01-0:00:00 <span class="at">--mem</span><span class="op">=</span>100G <span class="at">--nodes</span><span class="op">=</span>1 <span class="at">--wrap</span><span class="op">=</span><span class="st">&quot;R --no-save -q &lt; editFiles2.R&quot;</span></span></code></pre></div>
<ul>
<li>editFiles2.R</li>
</ul>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="k-mer-extraction-and-filtering.html#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb14-2"><a href="k-mer-extraction-and-filtering.html#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="k-mer-extraction-and-filtering.html#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb14-4"><a href="k-mer-extraction-and-filtering.html#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="k-mer-extraction-and-filtering.html#cb14-5" aria-hidden="true" tabindex="-1"></a>kmer_count <span class="ot">&lt;-</span> <span class="fu">fread</span>(<span class="st">&#39;kmer_count/kmer_count.tsv&#39;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-6"><a href="k-mer-extraction-and-filtering.html#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename_with</span>(<span class="sc">~</span> <span class="fu">str_extract</span>(., <span class="st">&quot;group[12](?:_</span><span class="sc">\\</span><span class="st">d{2}-</span><span class="sc">\\</span><span class="st">d{2})?&quot;</span>), <span class="sc">-</span><span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-7"><a href="k-mer-extraction-and-filtering.html#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TOTAL =</span> <span class="fu">rowSums</span>(<span class="fu">across</span>(<span class="sc">-</span><span class="dv">1</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb14-8"><a href="k-mer-extraction-and-filtering.html#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(TOTAL <span class="sc">&gt;=</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb14-9"><a href="k-mer-extraction-and-filtering.html#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="dv">1</span>, TOTAL) <span class="co">#45M</span></span>
<span id="cb14-10"><a href="k-mer-extraction-and-filtering.html#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="k-mer-extraction-and-filtering.html#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(<span class="fu">as.vector</span>(kmer_filterMin<span class="sc">$</span>kmer), <span class="at">file =</span> <span class="st">&#39;kmer_count/kmer_filterMin.rds&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="k-mer-extraction-and-filtering.html#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb15-2"><a href="k-mer-extraction-and-filtering.html#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=kmers</span></span>
<span id="cb15-3"><a href="k-mer-extraction-and-filtering.html#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=0-19</span></span>
<span id="cb15-4"><a href="k-mer-extraction-and-filtering.html#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=04:00:00</span></span>
<span id="cb15-5"><a href="k-mer-extraction-and-filtering.html#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=200G</span></span>
<span id="cb15-6"><a href="k-mer-extraction-and-filtering.html#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1</span></span>
<span id="cb15-7"><a href="k-mer-extraction-and-filtering.html#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="k-mer-extraction-and-filtering.html#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load R/4.2.1-foss-2022a</span>
<span id="cb15-9"><a href="k-mer-extraction-and-filtering.html#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="k-mer-extraction-and-filtering.html#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="va">FILES_LIST</span><span class="op">=</span><span class="va">($(</span><span class="fu">ls</span> FINAL_group2<span class="pp">*</span>.rds<span class="va">))</span></span>
<span id="cb15-11"><a href="k-mer-extraction-and-filtering.html#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="va">FILE</span><span class="op">=</span><span class="st">&quot;</span><span class="va">${FILES_LIST</span><span class="op">[</span><span class="va">$SLURM_ARRAY_TASK_ID</span><span class="op">]</span><span class="va">}</span><span class="st">&quot;</span></span>
<span id="cb15-12"><a href="k-mer-extraction-and-filtering.html#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="k-mer-extraction-and-filtering.html#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> editFiles3.R <span class="st">&quot;</span><span class="va">$FILE</span><span class="st">&quot;</span></span></code></pre></div>
<ul>
<li>editFiles3.R</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="k-mer-extraction-and-filtering.html#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb16-2"><a href="k-mer-extraction-and-filtering.html#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="k-mer-extraction-and-filtering.html#cb16-3" aria-hidden="true" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="at">trailingOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-4"><a href="k-mer-extraction-and-filtering.html#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(args[<span class="dv">1</span>])</span>
<span id="cb16-5"><a href="k-mer-extraction-and-filtering.html#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="k-mer-extraction-and-filtering.html#cb16-6" aria-hidden="true" tabindex="-1"></a>path_files <span class="ot">&lt;-</span> args[<span class="dv">1</span>]</span>
<span id="cb16-7"><a href="k-mer-extraction-and-filtering.html#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="k-mer-extraction-and-filtering.html#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb16-9"><a href="k-mer-extraction-and-filtering.html#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb16-10"><a href="k-mer-extraction-and-filtering.html#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tools)</span>
<span id="cb16-11"><a href="k-mer-extraction-and-filtering.html#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="k-mer-extraction-and-filtering.html#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&#39;/bulk/eakhunov/grcampos/embeddings/&#39;</span>)</span>
<span id="cb16-13"><a href="k-mer-extraction-and-filtering.html#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="k-mer-extraction-and-filtering.html#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="k-mer-extraction-and-filtering.html#cb16-15" aria-hidden="true" tabindex="-1"></a>tmp_dt <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&#39;kmer_count/&#39;</span>, path_files))</span>
<span id="cb16-16"><a href="k-mer-extraction-and-filtering.html#cb16-16" aria-hidden="true" tabindex="-1"></a>kmers <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&#39;kmer_count/kmer_filterMin.rds&#39;</span>)</span>
<span id="cb16-17"><a href="k-mer-extraction-and-filtering.html#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="k-mer-extraction-and-filtering.html#cb16-18" aria-hidden="true" tabindex="-1"></a>name_base <span class="ot">&lt;-</span> <span class="fu">file_path_sans_ext</span>(<span class="fu">basename</span>(path_files))</span>
<span id="cb16-19"><a href="k-mer-extraction-and-filtering.html#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="k-mer-extraction-and-filtering.html#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Min filter</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb16-21"><a href="k-mer-extraction-and-filtering.html#cb16-21" aria-hidden="true" tabindex="-1"></a>tmp_dt <span class="ot">&lt;-</span> tmp_dt[kmer <span class="sc">%in%</span> kmers]</span>
<span id="cb16-22"><a href="k-mer-extraction-and-filtering.html#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="k-mer-extraction-and-filtering.html#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Missing kmers</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb16-24"><a href="k-mer-extraction-and-filtering.html#cb16-24" aria-hidden="true" tabindex="-1"></a>missing_kmers <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(kmers, tmp_dt<span class="sc">$</span>kmer)</span>
<span id="cb16-25"><a href="k-mer-extraction-and-filtering.html#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="k-mer-extraction-and-filtering.html#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(missing_kmers) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb16-27"><a href="k-mer-extraction-and-filtering.html#cb16-27" aria-hidden="true" tabindex="-1"></a>  n_cols <span class="ot">&lt;-</span> <span class="fu">ncol</span>(tmp_dt) <span class="sc">-</span> <span class="dv">1</span></span>
<span id="cb16-28"><a href="k-mer-extraction-and-filtering.html#cb16-28" aria-hidden="true" tabindex="-1"></a>  tmp_missing <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">kmer =</span> missing_kmers,</span>
<span id="cb16-29"><a href="k-mer-extraction-and-filtering.html#cb16-29" aria-hidden="true" tabindex="-1"></a>                            <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">nrow =</span> <span class="fu">length</span>(missing_kmers), <span class="at">ncol =</span> n_cols))</span>
<span id="cb16-30"><a href="k-mer-extraction-and-filtering.html#cb16-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setnames</span>(tmp_missing, <span class="fu">colnames</span>(tmp_dt))</span>
<span id="cb16-31"><a href="k-mer-extraction-and-filtering.html#cb16-31" aria-hidden="true" tabindex="-1"></a>  tmp_dt <span class="ot">&lt;-</span> <span class="fu">rbind</span>(tmp_dt, tmp_missing)</span>
<span id="cb16-32"><a href="k-mer-extraction-and-filtering.html#cb16-32" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-33"><a href="k-mer-extraction-and-filtering.html#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="fu">gc</span>()</span>
<span id="cb16-34"><a href="k-mer-extraction-and-filtering.html#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="k-mer-extraction-and-filtering.html#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Ordering kmers</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb16-36"><a href="k-mer-extraction-and-filtering.html#cb16-36" aria-hidden="true" tabindex="-1"></a>tmp_dt <span class="ot">&lt;-</span> tmp_dt[<span class="fu">match</span>(kmers, tmp_dt<span class="sc">$</span>kmer)]</span>
<span id="cb16-37"><a href="k-mer-extraction-and-filtering.html#cb16-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-38"><a href="k-mer-extraction-and-filtering.html#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Saving</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb16-39"><a href="k-mer-extraction-and-filtering.html#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(tmp_dt, <span class="at">file =</span> <span class="fu">paste0</span>(<span class="st">&#39;kmer_count/&#39;</span>, name_base, <span class="st">&#39;_filter_min.rds&#39;</span>))</span>
<span id="cb16-40"><a href="k-mer-extraction-and-filtering.html#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="k-mer-extraction-and-filtering.html#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Done!</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
</div>
<div id="step-2-coefficient-of-variation-cv" class="section level3 hasAnchor" number="5.5.2">
<h3><span class="header-section-number">5.5.2</span> Step 2: Coefficient of Variation (CV)<a href="k-mer-extraction-and-filtering.html#step-2-coefficient-of-variation-cv" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Next, I wanted to keep only the most dynamic k-mers, so I calculated the coefficient of variation (CV) for each. This task was divided into ~4,000 chunks and submitted as SLURM jobs.</p>
<blockquote>
<p>Runtime? 48 hours.</p>
</blockquote>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="k-mer-extraction-and-filtering.html#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb17-2"><a href="k-mer-extraction-and-filtering.html#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --job-name=chunk_cv</span></span>
<span id="cb17-3"><a href="k-mer-extraction-and-filtering.html#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --array=374-4505%100</span></span>
<span id="cb17-4"><a href="k-mer-extraction-and-filtering.html#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --time=2-00:00:00</span></span>
<span id="cb17-5"><a href="k-mer-extraction-and-filtering.html#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --mem=50G</span></span>
<span id="cb17-6"><a href="k-mer-extraction-and-filtering.html#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co">#SBATCH --cpus-per-task=1</span></span>
<span id="cb17-7"><a href="k-mer-extraction-and-filtering.html#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="k-mer-extraction-and-filtering.html#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load R/4.2.1-foss-2022a</span>
<span id="cb17-9"><a href="k-mer-extraction-and-filtering.html#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="k-mer-extraction-and-filtering.html#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="ex">Rscript</span> kmers_CV_byChunck.R <span class="va">$SLURM_ARRAY_TASK_ID</span></span></code></pre></div>
<ul>
<li>kmers_CV_byChunck.R</li>
</ul>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="k-mer-extraction-and-filtering.html#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb18-2"><a href="k-mer-extraction-and-filtering.html#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="k-mer-extraction-and-filtering.html#cb18-3" aria-hidden="true" tabindex="-1"></a>args <span class="ot">&lt;-</span> <span class="fu">commandArgs</span>(<span class="at">trailingOnly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-4"><a href="k-mer-extraction-and-filtering.html#cb18-4" aria-hidden="true" tabindex="-1"></a>chunk_id <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(args[<span class="dv">1</span>])</span>
<span id="cb18-5"><a href="k-mer-extraction-and-filtering.html#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="k-mer-extraction-and-filtering.html#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb18-7"><a href="k-mer-extraction-and-filtering.html#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="k-mer-extraction-and-filtering.html#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">&#39;/bulk/eakhunov/grcampos/embeddings/&#39;</span>)</span>
<span id="cb18-9"><a href="k-mer-extraction-and-filtering.html#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="k-mer-extraction-and-filtering.html#cb18-10" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;kmer_count/&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;_filter_min.rds$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-11"><a href="k-mer-extraction-and-filtering.html#cb18-11" aria-hidden="true" tabindex="-1"></a>chunk_size <span class="ot">&lt;-</span> <span class="dv">10000</span></span>
<span id="cb18-12"><a href="k-mer-extraction-and-filtering.html#cb18-12" aria-hidden="true" tabindex="-1"></a>n_total <span class="ot">&lt;-</span> <span class="fu">nrow</span>(<span class="fu">readRDS</span>(files[<span class="dv">1</span>]))</span>
<span id="cb18-13"><a href="k-mer-extraction-and-filtering.html#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="k-mer-extraction-and-filtering.html#cb18-14" aria-hidden="true" tabindex="-1"></a>rowSds <span class="ot">&lt;-</span> <span class="cf">function</span>(x) <span class="fu">sqrt</span>(<span class="fu">rowMeans</span>((x <span class="sc">-</span> <span class="fu">rowMeans</span>(x))<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb18-15"><a href="k-mer-extraction-and-filtering.html#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="k-mer-extraction-and-filtering.html#cb18-16" aria-hidden="true" tabindex="-1"></a>line_start <span class="ot">&lt;-</span> (chunk_id <span class="sc">-</span> <span class="dv">1</span>) <span class="sc">*</span> chunk_size <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb18-17"><a href="k-mer-extraction-and-filtering.html#cb18-17" aria-hidden="true" tabindex="-1"></a>line_end <span class="ot">&lt;-</span> <span class="fu">min</span>(chunk_id <span class="sc">*</span> chunk_size, n_total)</span>
<span id="cb18-18"><a href="k-mer-extraction-and-filtering.html#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="k-mer-extraction-and-filtering.html#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Processing chunk&quot;</span>, chunk_id, <span class="st">&quot;:&quot;</span>, line_start, <span class="st">&quot;-&quot;</span>, line_end, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb18-20"><a href="k-mer-extraction-and-filtering.html#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="k-mer-extraction-and-filtering.html#cb18-21" aria-hidden="true" tabindex="-1"></a>all_cols <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">&quot;list&quot;</span>, <span class="fu">length</span>(files))</span>
<span id="cb18-22"><a href="k-mer-extraction-and-filtering.html#cb18-22" aria-hidden="true" tabindex="-1"></a>kmer_ref <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb18-23"><a href="k-mer-extraction-and-filtering.html#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="k-mer-extraction-and-filtering.html#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (j <span class="cf">in</span> <span class="fu">seq_along</span>(files)) {</span>
<span id="cb18-25"><a href="k-mer-extraction-and-filtering.html#cb18-25" aria-hidden="true" tabindex="-1"></a>  dt <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(files[j])[line_start<span class="sc">:</span>line_end]</span>
<span id="cb18-26"><a href="k-mer-extraction-and-filtering.html#cb18-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (j <span class="sc">==</span> <span class="dv">1</span>) kmer_ref <span class="ot">&lt;-</span> dt<span class="sc">$</span>kmer</span>
<span id="cb18-27"><a href="k-mer-extraction-and-filtering.html#cb18-27" aria-hidden="true" tabindex="-1"></a>  all_cols[[j]] <span class="ot">&lt;-</span> dt[, <span class="sc">-</span><span class="dv">1</span>, with <span class="ot">=</span> <span class="cn">FALSE</span>]</span>
<span id="cb18-28"><a href="k-mer-extraction-and-filtering.html#cb18-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-29"><a href="k-mer-extraction-and-filtering.html#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="k-mer-extraction-and-filtering.html#cb18-30" aria-hidden="true" tabindex="-1"></a>mat <span class="ot">&lt;-</span> <span class="fu">do.call</span>(cbind, all_cols)</span>
<span id="cb18-31"><a href="k-mer-extraction-and-filtering.html#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="k-mer-extraction-and-filtering.html#cb18-32" aria-hidden="true" tabindex="-1"></a>media <span class="ot">&lt;-</span> <span class="fu">rowMeans</span>(mat)</span>
<span id="cb18-33"><a href="k-mer-extraction-and-filtering.html#cb18-33" aria-hidden="true" tabindex="-1"></a>desvio <span class="ot">&lt;-</span> <span class="fu">rowSds</span>(mat)</span>
<span id="cb18-34"><a href="k-mer-extraction-and-filtering.html#cb18-34" aria-hidden="true" tabindex="-1"></a>cv <span class="ot">&lt;-</span> desvio <span class="sc">/</span> media</span>
<span id="cb18-35"><a href="k-mer-extraction-and-filtering.html#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="k-mer-extraction-and-filtering.html#cb18-36" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">kmer =</span> kmer_ref, <span class="at">mean =</span> media, <span class="at">sd =</span> desvio, <span class="at">cv =</span> cv)</span>
<span id="cb18-37"><a href="k-mer-extraction-and-filtering.html#cb18-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-38"><a href="k-mer-extraction-and-filtering.html#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="co"># saving</span></span>
<span id="cb18-39"><a href="k-mer-extraction-and-filtering.html#cb18-39" aria-hidden="true" tabindex="-1"></a>out_path <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">&quot;kmer_count/chunks_cv/chunk_%04d.rds&quot;</span>, chunk_id)</span>
<span id="cb18-40"><a href="k-mer-extraction-and-filtering.html#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">&quot;kmer_count/chunks_cv&quot;</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-41"><a href="k-mer-extraction-and-filtering.html#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(result, out_path)</span>
<span id="cb18-42"><a href="k-mer-extraction-and-filtering.html#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="k-mer-extraction-and-filtering.html#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">&quot;Chunk&quot;</span>, chunk_id, <span class="st">&quot;saved to&quot;</span>, out_path, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span></code></pre></div>
<p><strong>Output:</strong> All files are available in the folder <code>CVbyChunck.tar.xz</code>.</p>
<p>After processing all chunks, results were combined and kmers in the <strong>top 25%</strong> of CV were retained.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="k-mer-extraction-and-filtering.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load R/4.2.1-foss-2022a</span>
<span id="cb19-2"><a href="k-mer-extraction-and-filtering.html#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="k-mer-extraction-and-filtering.html#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--job-name</span><span class="op">=</span>R <span class="at">--time</span><span class="op">=</span>01-0:00:00 <span class="at">--mem</span><span class="op">=</span>100G <span class="at">--nodes</span><span class="op">=</span>1 <span class="at">--wrap</span><span class="op">=</span><span class="st">&quot;R --no-save -q &lt; editFiles4.R&quot;</span></span></code></pre></div>
<ul>
<li>editFiles4.R</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="k-mer-extraction-and-filtering.html#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb20-2"><a href="k-mer-extraction-and-filtering.html#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="k-mer-extraction-and-filtering.html#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb20-4"><a href="k-mer-extraction-and-filtering.html#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb20-5"><a href="k-mer-extraction-and-filtering.html#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="k-mer-extraction-and-filtering.html#cb20-6" aria-hidden="true" tabindex="-1"></a>file_paths <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&#39;kmer_count/chunks_cv/&#39;</span>, <span class="fu">list.files</span>(<span class="st">&#39;kmer_count/chunks_cv/&#39;</span>))</span>
<span id="cb20-7"><a href="k-mer-extraction-and-filtering.html#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="k-mer-extraction-and-filtering.html#cb20-8" aria-hidden="true" tabindex="-1"></a>kmer_cv <span class="ot">&lt;-</span> <span class="fu">lapply</span>(file_paths, readRDS)</span>
<span id="cb20-9"><a href="k-mer-extraction-and-filtering.html#cb20-9" aria-hidden="true" tabindex="-1"></a>kmer_cv <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, kmer_cv)</span>
<span id="cb20-10"><a href="k-mer-extraction-and-filtering.html#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="k-mer-extraction-and-filtering.html#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(kmer_count<span class="sc">$</span>kmer <span class="sc">%in%</span> kmer_cv<span class="sc">$</span>kmer)</span>
<span id="cb20-12"><a href="k-mer-extraction-and-filtering.html#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="k-mer-extraction-and-filtering.html#cb20-13" aria-hidden="true" tabindex="-1"></a>kmer_metrics <span class="ot">&lt;-</span> <span class="fu">left_join</span>(kmer_cv, kmer_count, <span class="at">by =</span> <span class="st">&quot;kmer&quot;</span>)</span>
<span id="cb20-14"><a href="k-mer-extraction-and-filtering.html#cb20-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-15"><a href="k-mer-extraction-and-filtering.html#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co"># top 25%</span></span>
<span id="cb20-16"><a href="k-mer-extraction-and-filtering.html#cb20-16" aria-hidden="true" tabindex="-1"></a>fasta_lines <span class="ot">&lt;-</span>  kmer_metrics <span class="sc">%&gt;%</span></span>
<span id="cb20-17"><a href="k-mer-extraction-and-filtering.html#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(cv <span class="sc">&gt;</span> <span class="fu">quantile</span>(cv, <span class="fl">0.75</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb20-18"><a href="k-mer-extraction-and-filtering.html#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(cv), <span class="fu">desc</span>(TOTAL)) <span class="sc">%&gt;%</span></span>
<span id="cb20-19"><a href="k-mer-extraction-and-filtering.html#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>mean, <span class="sc">-</span>sd)</span>
<span id="cb20-20"><a href="k-mer-extraction-and-filtering.html#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="k-mer-extraction-and-filtering.html#cb20-21" aria-hidden="true" tabindex="-1"></a>fasta_lines <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;&gt;kmer&quot;</span>, <span class="fu">seq_len</span>(<span class="fu">nrow</span>(kmer_metrics)), <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, kmer_metrics<span class="sc">$</span>kmer)</span>
<span id="cb20-22"><a href="k-mer-extraction-and-filtering.html#cb20-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-23"><a href="k-mer-extraction-and-filtering.html#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="fu">write_lines</span>(fasta_lines, <span class="st">&quot;kmers_min_cv.fa&quot;</span>)</span></code></pre></div>
<blockquote>
<p><strong>Note:</strong> The resulting file <code>kmers_min_cv.fa</code> contains the most variable and abundant k-mers for <code>cd-hit-est</code> clustering.</p>
</blockquote>
</div>
<div id="step-3-redundancy-removal-with-cd-hit-est" class="section level3 hasAnchor" number="5.5.3">
<h3><span class="header-section-number">5.5.3</span> Step 3: Redundancy Removal with CD-HIT-EST<a href="k-mer-extraction-and-filtering.html#step-3-redundancy-removal-with-cd-hit-est" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally, to avoid feeding the models with 10 slightly different versions of the same sequence, I ran <code>CD-HIT-EST</code> with a <strong>95% identity threshold</strong>. Only one representative per cluster was kept.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="k-mer-extraction-and-filtering.html#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load CD-HIT/4.8.1-GCC-11.3.0</span>
<span id="cb21-2"><a href="k-mer-extraction-and-filtering.html#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="k-mer-extraction-and-filtering.html#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--job-name</span><span class="op">=</span>CdH <span class="at">--time</span><span class="op">=</span>05:00:00 <span class="at">--mem</span><span class="op">=</span>200G <span class="at">--ntasks-per-node</span><span class="op">=</span>20 <span class="at">--nodes</span><span class="op">=</span>1 <span class="at">--wrap</span><span class="op">=</span><span class="st">&quot;cd-hit-est -i kmers_min_cv.fa -o kmers_clustered.fa -c 0.95 -n 8 -T 20 -M 200000 -d 0&quot;</span></span></code></pre></div>
<p><strong>Output:</strong> Clustering results and retained sequences are in the <code>cd-hit.tar.xz</code> folder.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="k-mer-extraction-and-filtering.html#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load R/4.2.1-foss-2022a</span>
<span id="cb22-2"><a href="k-mer-extraction-and-filtering.html#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="k-mer-extraction-and-filtering.html#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">sbatch</span> <span class="at">--job-name</span><span class="op">=</span>R <span class="at">--time</span><span class="op">=</span>01-0:00:00 <span class="at">--mem</span><span class="op">=</span>100G <span class="at">--nodes</span><span class="op">=</span>1 <span class="at">--wrap</span><span class="op">=</span><span class="st">&quot;R --no-save -q &lt; editFiles5.R&quot;</span></span></code></pre></div>
<ul>
<li>editFiles5.R</li>
</ul>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="k-mer-extraction-and-filtering.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env Rscript</span></span>
<span id="cb23-2"><a href="k-mer-extraction-and-filtering.html#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="k-mer-extraction-and-filtering.html#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb23-4"><a href="k-mer-extraction-and-filtering.html#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb23-5"><a href="k-mer-extraction-and-filtering.html#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Biostrings)</span>
<span id="cb23-6"><a href="k-mer-extraction-and-filtering.html#cb23-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-7"><a href="k-mer-extraction-and-filtering.html#cb23-7" aria-hidden="true" tabindex="-1"></a>cdhit <span class="ot">&lt;-</span> <span class="fu">readDNAStringSet</span>(<span class="st">&quot;kmers_clustered.fa&quot;</span>)</span>
<span id="cb23-8"><a href="k-mer-extraction-and-filtering.html#cb23-8" aria-hidden="true" tabindex="-1"></a>seqs <span class="ot">&lt;-</span> <span class="fu">as.character</span>(cdhit)</span>
<span id="cb23-9"><a href="k-mer-extraction-and-filtering.html#cb23-9" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(seqs)</span>
<span id="cb23-10"><a href="k-mer-extraction-and-filtering.html#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(seqs) </span>
<span id="cb23-11"><a href="k-mer-extraction-and-filtering.html#cb23-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-12"><a href="k-mer-extraction-and-filtering.html#cb23-12" aria-hidden="true" tabindex="-1"></a>kmer_metrics <span class="ot">&lt;-</span> <span class="fu">filter</span>(kmer_metrics, kmer <span class="sc">%in%</span> seqs) <span class="co">#4.5M</span></span>
<span id="cb23-13"><a href="k-mer-extraction-and-filtering.html#cb23-13" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(kmer_metrics)</span>
<span id="cb23-14"><a href="k-mer-extraction-and-filtering.html#cb23-14" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(kmer_metrics<span class="sc">$</span>cv)</span>
<span id="cb23-15"><a href="k-mer-extraction-and-filtering.html#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="k-mer-extraction-and-filtering.html#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># count matrices ----</span></span>
<span id="cb23-17"><a href="k-mer-extraction-and-filtering.html#cb23-17" aria-hidden="true" tabindex="-1"></a>path_count <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="st">&quot;kmer_count&quot;</span>, <span class="at">pattern =</span> <span class="st">&quot;_filter_min.rds$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-18"><a href="k-mer-extraction-and-filtering.html#cb23-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-19"><a href="k-mer-extraction-and-filtering.html#cb23-19" aria-hidden="true" tabindex="-1"></a>count_clean <span class="ot">&lt;-</span> <span class="fu">data.table</span>()</span>
<span id="cb23-20"><a href="k-mer-extraction-and-filtering.html#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="k-mer-extraction-and-filtering.html#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(path_count)){ <span class="co">#4h</span></span>
<span id="cb23-22"><a href="k-mer-extraction-and-filtering.html#cb23-22" aria-hidden="true" tabindex="-1"></a>  tmp <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(path_count[i]) <span class="sc">%&gt;%</span> </span>
<span id="cb23-23"><a href="k-mer-extraction-and-filtering.html#cb23-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(kmer <span class="sc">%in%</span> seqs2) <span class="sc">%&gt;%</span> </span>
<span id="cb23-24"><a href="k-mer-extraction-and-filtering.html#cb23-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">factor</span>(kmer, <span class="at">levels =</span> seqs)) <span class="sc">%&gt;%</span></span>
<span id="cb23-25"><a href="k-mer-extraction-and-filtering.html#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">column_to_rownames</span>(<span class="at">var =</span> <span class="st">&#39;kmer&#39;</span>)</span>
<span id="cb23-26"><a href="k-mer-extraction-and-filtering.html#cb23-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb23-27"><a href="k-mer-extraction-and-filtering.html#cb23-27" aria-hidden="true" tabindex="-1"></a>  count_clean <span class="ot">&lt;-</span> <span class="fu">cbind</span>(count_clean, tmp)</span>
<span id="cb23-28"><a href="k-mer-extraction-and-filtering.html#cb23-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb23-29"><a href="k-mer-extraction-and-filtering.html#cb23-29" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(count_clean) <span class="ot">&lt;-</span> seqs</span>
<span id="cb23-30"><a href="k-mer-extraction-and-filtering.html#cb23-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-31"><a href="k-mer-extraction-and-filtering.html#cb23-31" aria-hidden="true" tabindex="-1"></a>kmer_metrics_grouped <span class="ot">&lt;-</span> kmer_metrics <span class="sc">%&gt;%</span></span>
<span id="cb23-32"><a href="k-mer-extraction-and-filtering.html#cb23-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(mean, sd, TOTAL, cv) <span class="sc">%&gt;%</span></span>
<span id="cb23-33"><a href="k-mer-extraction-and-filtering.html#cb23-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">group_id =</span> <span class="fu">cur_group_id</span>()) <span class="sc">%&gt;%</span></span>
<span id="cb23-34"><a href="k-mer-extraction-and-filtering.html#cb23-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb23-35"><a href="k-mer-extraction-and-filtering.html#cb23-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()</span>
<span id="cb23-36"><a href="k-mer-extraction-and-filtering.html#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="k-mer-extraction-and-filtering.html#cb23-37" aria-hidden="true" tabindex="-1"></a>kmer_unique <span class="ot">&lt;-</span> kmer_metrics_grouped[<span class="sc">!</span><span class="fu">duplicated</span>(kmer_metrics_grouped<span class="sc">$</span>group_id), ]</span>
<span id="cb23-38"><a href="k-mer-extraction-and-filtering.html#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="k-mer-extraction-and-filtering.html#cb23-39" aria-hidden="true" tabindex="-1"></a>count_clean2 <span class="ot">&lt;-</span> count_clean <span class="sc">%&gt;%</span></span>
<span id="cb23-40"><a href="k-mer-extraction-and-filtering.html#cb23-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">&quot;kmer&quot;</span>) <span class="sc">%&gt;%</span>           </span>
<span id="cb23-41"><a href="k-mer-extraction-and-filtering.html#cb23-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(kmer <span class="sc">%in%</span> kmer_unique<span class="sc">$</span>kmer) <span class="sc">%&gt;%</span>  </span>
<span id="cb23-42"><a href="k-mer-extraction-and-filtering.html#cb23-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">column_to_rownames</span>(<span class="st">&quot;kmer&quot;</span>)         </span>
<span id="cb23-43"><a href="k-mer-extraction-and-filtering.html#cb23-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-44"><a href="k-mer-extraction-and-filtering.html#cb23-44" aria-hidden="true" tabindex="-1"></a>count_clean2 <span class="ot">&lt;-</span> <span class="fu">log2</span>(count_clean2 <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb23-45"><a href="k-mer-extraction-and-filtering.html#cb23-45" aria-hidden="true" tabindex="-1"></a>count_clean2 <span class="ot">&lt;-</span> <span class="fu">t</span>(count_clean2)</span>
<span id="cb23-46"><a href="k-mer-extraction-and-filtering.html#cb23-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-47"><a href="k-mer-extraction-and-filtering.html#cb23-47" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(count_clean, <span class="st">&#39;results/count_clean.rds&#39;</span>)</span>
<span id="cb23-48"><a href="k-mer-extraction-and-filtering.html#cb23-48" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(kmer_metrics, <span class="st">&#39;results/kmer_metrics.rds&#39;</span>)</span>
<span id="cb23-49"><a href="k-mer-extraction-and-filtering.html#cb23-49" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(count_clean2, <span class="st">&#39;results/count_clean2.rds&#39;</span>)</span></code></pre></div>
<blockquote>
<p>All scripts used in this <del>straightforward</del> chain of events are available in the <code>scripts/</code> directory, for anyone brave (or curious) enough to follow the path.</p>
</blockquote>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="pseudosamples-from-raw-reads.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="exploratory-analysis.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/USERNAME/REPO/edit/BRANCH/04_kmer_quant.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["_main.pdf", "_main.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
},
"self_contained": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
